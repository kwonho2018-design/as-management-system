<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A/S 통합 관리 시스템</title>
    <!-- Tailwind CSS 3.4.1 CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome 6 CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js 3.9.1 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Chart.js DataLabels Plugin 2.2.0 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <!-- SheetJS xlsx 0.18.5 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Firebase 9 SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, setDoc, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';
        
        // Firebase 설정 (실제 프로젝트 구성)
        const firebaseConfig = {
            apiKey: "AIzaSyDL6_y_1zFcBBRjCQczFMaBbqHXtGnzoL8",
            authDomain: "as-system-c4ce8.firebaseapp.com",
            projectId: "as-system-c4ce8",
            storageBucket: "as-system-c4ce8.firebasestorage.app",
            messagingSenderId: "835934257461",
            appId: "1:835934257461:web:1ae2bd8b56e2d62cb68c7c",
            measurementId: "G-QW0QZ7BED0"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // 전역으로 설정
        window.firebaseDB = db;
        window.firebaseOperations = {
            collection,
            addDoc,
            getDocs,
            doc,
            updateDoc,
            deleteDoc,
            setDoc,
            query,
            orderBy,
            limit
        };

        // Firebase 초기화 완료 이벤트 발생
        window.dispatchEvent(new Event('firebaseReady'));
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
        }
        .glass-card {
            background: rgba(31, 41, 55, 0.5);
            border-radius: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(75, 85, 99, 0.5);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .hover-lift {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.15);
        }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-green { background-color: #10b981; color: white; }
        .btn-green:hover { background-color: #059669; }
        .btn-orange { background-color: #f59e0b; color: white; }
        .btn-orange:hover { background-color: #d97706; }
        .btn-red { background-color: #ef4444; color: white; }
        .btn-red:hover { background-color: #dc2626; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-input {
            color: white;
            background-color: rgba(55, 65, 81, 0.7);
            border: 1px solid #4b5563;
        }
        .modal-input::placeholder { color: #9ca3af; }
        .modal-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
        }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        th { background-color: rgba(55, 65, 81, 0.5); color: #d1d5db; }
        tr:nth-child(even) { background-color: rgba(55, 65, 81, 0.2); }

        .drag-drop-zone {
            border: 2px dashed rgba(107, 114, 128, 0.5);
            padding: 20px; text-align: center; cursor: pointer;
            transition: background-color 0.3s;
        }
        .drag-drop-zone.dragover { background-color: rgba(75, 85, 99, 0.4); }

        /* A/S Specific Styles */
        .as-sub-nav-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, color 0.2s;
            border-bottom: 3px solid transparent;
        }
        .as-sub-nav-btn.active {
            background-color: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border-bottom-color: #3b82f6;
        }
        .as-sub-tab-content { display: none; }
        .as-sub-tab-content.active { display: block; }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status-indicator {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-online { background-color: #10b981; color: white; }
        .status-offline { background-color: #ef4444; color: white; }
    </style>
</head>
<body>
    <div class="min-h-screen p-6">
        <!-- Header -->
        <header class="mb-6 glass-card p-5">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-tools text-2xl text-blue-400"></i>
                    <h1 class="text-2xl font-bold text-white">A/S 통합 관리 시스템</h1>
                    <div id="connection-status" class="status-indicator status-offline">연결 중...</div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="loading-indicator" class="loading-spinner" style="display: none;"></div>
                    <button onclick="downloadHTML()" class="py-2 px-4 rounded-md btn-primary text-sm">
                        <i class="fas fa-download mr-2"></i>현재 상태 저장 (HTML)
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="glass-card p-6">
            <!-- Sub-navigation -->
            <div class="mb-6">
                <div class="border-b border-gray-700">
                    <nav id="as-sub-nav" class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button onclick="showAsSubTab('dashboard')" class="as-sub-nav-btn" data-tab="dashboard">대시보드</button>
                        <button onclick="showAsSubTab('general')" class="as-sub-nav-btn" data-tab="general">기타제품</button>
                        <button onclick="showAsSubTab('converter')" class="as-sub-nav-btn" data-tab="converter">컨버터</button>
                        <button onclick="showAsSubTab('floodlight')" class="as-sub-nav-btn" data-tab="floodlight">투광등</button>
                        <button onclick="showAsSubTab('integrated')" class="as-sub-nav-btn" data-tab="integrated">통합 보기</button>
                    </nav>
                </div>
            </div>

            <!-- Sub-tab content -->
            <div id="as-dashboard-content" class="as-sub-tab-content"></div>
            <div id="as-general-content" class="as-sub-tab-content"></div>
            <div id="as-converter-content" class="as-sub-tab-content"></div>
            <div id="as-floodlight-content" class="as-sub-tab-content"></div>
            <div id="as-integrated-content" class="as-sub-tab-content"></div>
        </main>
    </div>

    <!-- Modals -->
    <div id="generic-modal" class="modal-overlay" style="display: none;"></div>
    <div id="confirm-modal" class="modal-overlay" style="display: none;">
        <div class="glass-card p-6 w-full max-w-sm mx-4 text-white">
            <h2 class="text-xl font-bold mb-4">확인</h2>
            <p id="confirm-modal-text" class="mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500">취소</button>
                <button id="confirm-ok-btn" class="py-2 px-4 rounded-md btn-red">확인</button>
            </div>
        </div>
    </div>

    <script>
        // --- Global State ---
        let isOnline = false;
        let firebaseReady = false;
        
        const appData = {
            as: {
                general: [],
                converter: [],
                floodlight: []
            },
            recentActivities: []
        };

        let asCharts = { dashboard: null, general: null, converter: null, floodlight: null, integrated: null };
        let currentModalType = null, currentEditId = null, confirmCallback = null;

        // --- A/S State ---
        const asState = {
            activeTab: 'dashboard',
            activeCategory: 'general',
            activeSubTab: {
                general: 'incomplete',
                converter: 'incomplete',
                floodlight: 'incomplete',
                integrated: 'data'
            },
            selectedIds: {
                general: new Set(),
                converter: new Set(),
                floodlight: new Set(),
                integrated: new Set()
            },
            integratedFilter: 'all',
            integratedStatusFilter: 'all'
        };

        // --- Config ---
        const AS_CONFIG = {
            general: { 
                name: '기타제품', 
                store: 'as_general', 
                fields: { 
                    'NO.': 'NO.', 
                    '구분': '구분', 
                    '클레임 NO.': '클레임NO', 
                    '호선번호': '호선번호', 
                    '불량 자재코드': '불량자재코드', 
                    '대체 자재 코드': '대체자재코드', 
                    '제품명': '제품명', 
                    '수량': '수량', 
                    '접수일': '접수일', 
                    '완료일': '완료일', 
                    '비고': '비고' 
                } 
            },
            converter: { 
                name: '컨버터', 
                store: 'as_converter', 
                fields: { 
                    'NO.': 'NO.', 
                    '구분': '구분', 
                    '클레임 NO.': '클레임NO', 
                    '호선번호': '호선번호', 
                    '컨버터 번호': '컨버터번호', 
                    '컨버터 코드': '컨버터코드', 
                    '설치 위치': '설치위치', 
                    '제품명': '제품명', 
                    '수량': '수량', 
                    '접수일': '접수일', 
                    '완료일': '완료일', 
                    '비고': '비고' 
                } 
            },
            floodlight: { 
                name: '투광등', 
                store: 'as_floodlight', 
                fields: { 
                    'NO.': 'NO.', 
                    '구분': '구분', 
                    '클레임 NO.': '클레임NO', 
                    '호선번호': '호선번호', 
                    '불량 자재코드': '불량자재코드', 
                    '대체 자재 코드': '대체자재코드', 
                    '제품명': '제품명', 
                    '수량': '수량', 
                    '접수일': '접수일', 
                    '완료일': '완료일', 
                    '비고': '비고' 
                } 
            }
        };

        // --- Utility Functions ---
        function getTodayString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDate(date) {
            if (!date && date !== 0) return '';
            
            // 이미 YYYY-MM-DD 형식인 경우 그대로 반환
            if (typeof date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(date)) {
                return date;
            }
            
            const d = new Date(date);
            if (isNaN(d.getTime())) {
                // Excel serial date number 처리
                if (typeof date === 'number' && date > 0) {
                    const excelEpoch = new Date(1899, 11, 30);
                    d.setTime(excelEpoch.getTime() + (Number(date) - 1) * 86400000);
                } else {
                    return '';
                }
            }
            
            if (isNaN(d.getTime())) return '';
            
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function psmEscapeHtml(unsafe) {
            if (unsafe == null) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;");
        }

        function showLoading() {
            document.getElementById('loading-indicator').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading-indicator').style.display = 'none';
        }

        function updateConnectionStatus(online) {
            isOnline = online;
            const statusEl = document.getElementById('connection-status');
            if (online && firebaseReady) {
                statusEl.textContent = '온라인';
                statusEl.className = 'status-indicator status-online';
            } else {
                statusEl.textContent = firebaseReady ? '오프라인' : '연결 중...';
                statusEl.className = 'status-indicator status-offline';
            }
        }

        // --- Firebase Operations ---
        async function initFirebase() {
            try {
                // Firebase 모듈이 로드될 때까지 대기
                let attempts = 0;
                while (!window.firebaseDB && attempts < 100) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (!window.firebaseDB) {
                    throw new Error('Firebase 초기화 실패');
                }
                
                // 연결 테스트
                const testDoc = await window.firebaseOperations.getDocs(
                    window.firebaseOperations.query(
                        window.firebaseOperations.collection(window.firebaseDB, 'test'),
                        window.firebaseOperations.limit(1)
                    )
                );
                
                firebaseReady = true;
                updateConnectionStatus(true);
                console.log('Firebase 연결 성공');
                return true;
            } catch (error) {
                console.error('Firebase 초기화 오류:', error);
                firebaseReady = false;
                updateConnectionStatus(false);
                return false;
            }
        }

        async function loadAllDataFromFirebase() {
            if (!window.firebaseDB || !isOnline || !firebaseReady) {
                console.log('Firebase 로드 조건 미충족:', { firebaseDB: !!window.firebaseDB, isOnline, firebaseReady });
                return;
            }
            
            showLoading();
            try {
                const { collection, getDocs } = window.firebaseOperations;
                
                // 각 카테고리별 데이터 로드
                for (const category of Object.keys(AS_CONFIG)) {
                    try {
                        const querySnapshot = await getDocs(collection(window.firebaseDB, AS_CONFIG[category].store));
                        appData.as[category] = [];
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            // ID 일관성 보장
                            data.id = data.id || doc.id;
                            appData.as[category].push(data);
                        });
                        asReindex(category);
                        console.log(`${AS_CONFIG[category].name} 데이터 로드 완료: ${appData.as[category].length}개`);
                    } catch (error) {
                        console.error(`${AS_CONFIG[category].name} 데이터 로드 오류:`, error);
                    }
                }

                // 최근 활동 로드
                try {
                    const activitiesSnapshot = await getDocs(collection(window.firebaseDB, 'recentActivities'));
                    appData.recentActivities = [];
                    activitiesSnapshot.forEach((doc) => {
                        appData.recentActivities.push({ id: doc.id, ...doc.data() });
                    });
                    appData.recentActivities.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                    console.log('최근 활동 로드 완료:', appData.recentActivities.length);
                } catch (error) {
                    console.error('최근 활동 로드 오류:', error);
                }

            } catch (error) {
                console.error('데이터 로드 오류:', error);
                updateConnectionStatus(false);
            } finally {
                hideLoading();
            }
        }

        async function saveItemToFirebase(category, item) {
            if (!window.firebaseDB || !isOnline || !firebaseReady) return;
            
            try {
                const { doc, setDoc } = window.firebaseOperations;
                const docRef = doc(window.firebaseDB, AS_CONFIG[category].store, String(item.id));
                await setDoc(docRef, item);
                console.log(`${AS_CONFIG[category].name} 항목 저장 완료:`, item.id);
            } catch (error) {
                console.error(`${AS_CONFIG[category].name} 데이터 저장 오류:`, error);
                throw error;
            }
        }

        async function deleteItemFromFirebase(category, itemId) {
            if (!window.firebaseDB || !isOnline || !firebaseReady) return;
            
            try {
                const { doc, deleteDoc } = window.firebaseOperations;
                await deleteDoc(doc(window.firebaseDB, AS_CONFIG[category].store, String(itemId)));
                console.log(`${AS_CONFIG[category].name} 항목 삭제 완료:`, itemId);
            } catch (error) {
                console.error(`${AS_CONFIG[category].name} 데이터 삭제 오류:`, error);
                throw error;
            }
        }

        async function saveBulkDataToFirebase(category, items) {
            if (!window.firebaseDB || !isOnline || !firebaseReady) return;
            
            showLoading();
            try {
                const { doc, setDoc } = window.firebaseOperations;
                const promises = items.map(item => 
                    setDoc(doc(window.firebaseDB, AS_CONFIG[category].store, String(item.id)), item)
                );
                await Promise.all(promises);
                console.log(`${AS_CONFIG[category].name} 대량 저장 완료: ${items.length}개`);
            } catch (error) {
                console.error(`${AS_CONFIG[category].name} 대량 데이터 저장 오류:`, error);
                throw error;
            } finally {
                hideLoading();
            }
        }

        async function clearCategoryInFirebase(category) {
            if (!window.firebaseDB || !isOnline || !firebaseReady) return;
            
            showLoading();
            try {
                const { collection, getDocs, deleteDoc, doc } = window.firebaseOperations;
                const querySnapshot = await getDocs(collection(window.firebaseDB, AS_CONFIG[category].store));
                const deletePromises = [];
                querySnapshot.forEach((docSnapshot) => {
                    deletePromises.push(deleteDoc(doc(window.firebaseDB, AS_CONFIG[category].store, docSnapshot.id)));
                });
                await Promise.all(deletePromises);
                console.log(`${AS_CONFIG[category].name} 데이터 초기화 완료`);
            } catch (error) {
                console.error(`${AS_CONFIG[category].name} 카테고리 데이터 삭제 오류:`, error);
                throw error;
            } finally {
                hideLoading();
            }
        }

        // --- Recent Activities ---
        async function addRecentActivity(type, message, itemName) {
            const activity = {
                id: Date.now(),
                type,
                message,
                itemName,
                timestamp: Date.now(),
                icon: getActivityIcon(type)
            };
            
            appData.recentActivities.unshift(activity);
            if (appData.recentActivities.length > 50) {
                appData.recentActivities.pop();
            }
            
            if (isOnline && firebaseReady) {
                try {
                    const { doc, setDoc } = window.firebaseOperations;
                    await setDoc(doc(window.firebaseDB, 'recentActivities', String(activity.id)), activity);
                } catch (error) {
                    console.error('활동 저장 오류:', error);
                }
            }
        }

        function getActivityIcon(type) {
            const icons = {
                'AS': 'fas fa-tools',
                'ASImport': 'fas fa-file-import',
                'ASExport': 'fas fa-file-export',
                'ASComplete': 'fas fa-check-circle',
                'System': 'fas fa-info-circle'
            };
            return icons[type] || 'fas fa-bell';
        }

        // --- Common AS Functions ---
        function asReindex(category) {
            const list = appData.as[category];
            list.sort((a, b) => (parseInt(a['NO.']) || 0) - (parseInt(b['NO.']) || 0));
            list.forEach((item, idx) => {
                item['NO.'] = idx + 1;
            });
        }

        function asGetNextNo(category) {
            const list = appData.as[category];
            return list.length ? Math.max(...list.map(i => +i['NO.'] || 0)) + 1 : 1;
        }

        // --- UI Functions ---
        function showAsSubTab(tab) {
            asState.activeTab = tab;
            asState.activeCategory = (tab === 'dashboard' || tab === 'integrated') ? null : tab;

            document.querySelectorAll('#as-sub-nav .as-sub-nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#as-sub-nav .as-sub-nav-btn[data-tab="${tab}"]`).classList.add('active');

            document.querySelectorAll('.as-sub-tab-content').forEach(content => content.classList.remove('active'));
            const contentEl = document.getElementById(`as-${tab}-content`);
            contentEl.classList.add('active');

            switch(tab) {
                case 'dashboard':
                    renderAsDashboard();
                    break;
                case 'general':
                case 'converter':
                case 'floodlight':
                    renderAsCategory(tab);
                    break;
                case 'integrated':
                    renderAsIntegrated();
                    break;
            }
        }

        function renderAsDashboard() {
            const container = document.getElementById('as-dashboard-content');
            if(!container) return;

            const allItems = [...appData.as.general, ...appData.as.converter, ...appData.as.floodlight];
            const total = allItems.length;
            const completed = allItems.filter(item => item.status === 'completed').length;
            const incomplete = total - completed;
            const completionRate = total > 0 ? ((completed / total) * 100).toFixed(1) : '0.0';

            const categoryStats = Object.keys(AS_CONFIG).map(cat => {
                const items = appData.as[cat];
                const catTotal = items.length;
                const catCompleted = items.filter(i => i.status === 'completed').length;
                const catIncomplete = catTotal - catCompleted;
                const catRate = catTotal > 0 ? ((catCompleted / catTotal) * 100).toFixed(1) : '0.0';
                return { name: AS_CONFIG[cat].name, total: catTotal, completed: catCompleted, incomplete: catIncomplete, rate: catRate };
            });

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="glass-card p-5"><p class="text-gray-400">총 A/S 건수</p><p class="text-white text-3xl font-bold">${total}</p></div>
                    <div class="glass-card p-5"><p class="text-gray-400">완료 건수</p><p class="text-green-400 text-3xl font-bold">${completed}</p></div>
                    <div class="glass-card p-5"><p class="text-gray-400">미완료 건수</p><p class="text-red-400 text-3xl font-bold">${incomplete}</p></div>
                    <div class="glass-card p-5"><p class="text-gray-400">전체 완료율</p><p class="text-blue-400 text-3xl font-bold">${completionRate}%</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    ${categoryStats.map(stat => `
                        <div class="glass-card p-5">
                            <h3 class="text-lg font-semibold text-white mb-3">${stat.name} 현황</h3>
                            <div class="flex justify-between items-center text-sm"><span>총계:</span> <span class="font-bold">${stat.total}</span></div>
                            <div class="flex justify-between items-center text-sm text-green-400"><span>완료:</span> <span class="font-bold">${stat.completed}</span></div>
                            <div class="flex justify-between items-center text-sm text-red-400"><span>미완료:</span> <span class="font-bold">${stat.incomplete}</span></div>
                            <div class="flex justify-between items-center text-sm text-blue-400 mt-2"><span>완료율:</span> <span class="font-bold">${stat.rate}%</span></div>
                        </div>
                    `).join('')}
                </div>
                <div class="glass-card p-6">
                    <h3 class="text-xl font-semibold text-white mb-4">제품군별 A/S 현황</h3>
                    <div class="h-96"><canvas id="as-dashboard-chart"></canvas></div>
                </div>
            `;

            const chartEl = document.getElementById('as-dashboard-chart');
            if (chartEl) {
                if (asCharts.dashboard) asCharts.dashboard.destroy();
                asCharts.dashboard = new Chart(chartEl, {
                    type: 'bar',
                    data: {
                        labels: categoryStats.map(s => s.name),
                        datasets: [
                            {
                                label: '완료',
                                data: categoryStats.map(s => s.completed),
                                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                                borderColor: '#10b981',
                                borderWidth: 1
                            },
                            {
                                label: '미완료',
                                data: categoryStats.map(s => s.incomplete),
                                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                                borderColor: '#ef4444',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#e5e7eb' }, grid: { color: '#374151' } },
                            x: { ticks: { color: '#e5e7eb' }, grid: { color: '#374151' } }
                        },
                        plugins: {
                            legend: { position: 'bottom', labels: { color: '#e5e7eb' } },
                            datalabels: {
                                color: 'white',
                                anchor: 'end',
                                align: 'end',
                                formatter: (value) => value > 0 ? value : ''
                            }
                        }
                    }
                });
            }
        }

        function renderAsCategory(category) {
            const container = document.getElementById(`as-${category}-content`);
            if(!container) return;

            const config = AS_CONFIG[category];
            const activeSubTab = asState.activeSubTab[category];

            container.innerHTML = `
                <div class="glass-card p-4 mb-6">
                    <div id="as-drop-zone-${category}" class="drag-drop-zone rounded-md" ondragover="handleDragOver(event, '${category}')" ondragleave="handleDragLeave(event, '${category}')" ondrop="handleDrop(event, '${category}')">
                        <p class="text-white">${config.name} Excel 파일을 여기로 드래그하거나 클릭하여 업로드</p>
                        <input type="file" id="as-file-input-${category}" accept=".xlsx, .xls, .csv" class="hidden" onchange="asHandleFileSelect(event, '${category}')">
                        <button class="mt-3 btn-green py-1 px-3 rounded text-sm" onclick="document.getElementById('as-file-input-${category}').click()">파일 선택</button>
                    </div>
                </div>
                <div class="border-b border-gray-700 mb-4">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button onclick="asSetCategorySubTab('${category}', 'incomplete')" class="as-sub-nav-btn ${activeSubTab === 'incomplete' ? 'active' : ''}">미완료</button>
                        <button onclick="asSetCategorySubTab('${category}', 'completed')" class="as-sub-nav-btn ${activeSubTab === 'completed' ? 'active' : ''}">완료</button>
                        <button onclick="asSetCategorySubTab('${category}', 'analysis')" class="as-sub-nav-btn ${activeSubTab === 'analysis' ? 'active' : ''}">분석(차트)</button>
                        <button onclick="asSetCategorySubTab('${category}', 'incomplete-list')" class="as-sub-nav-btn ${activeSubTab === 'incomplete-list' ? 'active' : ''}">미완료 제품 리스트</button>
                    </nav>
                </div>
                <div id="as-category-subcontent-${category}"></div>
            `;
            renderAsCategorySubContent(category);
        }

        function asSetCategorySubTab(category, subTab) {
            asState.activeSubTab[category] = subTab;
            renderAsCategory(category);
        }

        function renderAsCategorySubContent(category) {
            const container = document.getElementById(`as-category-subcontent-${category}`);
            const activeSubTab = asState.activeSubTab[category];

            if (activeSubTab === 'analysis') {
                container.innerHTML = `<div class="glass-card p-6 h-96"><canvas id="as-chart-${category}"></canvas></div>`;
                renderAsCategoryChart(category);
            } else if (activeSubTab === 'incomplete-list') {
                container.innerHTML = `
                    <div class="glass-card p-6">
                        <div id="as-incomplete-list-${category}"></div>
                    </div>
                `;
                renderAsCategoryIncompleteList(category);
            } else {
                const selectedCount = asState.selectedIds[category].size;
                container.innerHTML = `
                    <div class="glass-card p-4">
                        <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                            <div class="flex items-center gap-2">
                                <button class="btn-primary py-2 px-4 rounded-md text-sm" onclick="asOpenAddModal('${category}')"><i class="fas fa-plus mr-2"></i>항목 추가</button>
                                <button class="btn-red py-2 px-4 rounded-md text-sm" onclick="asDeleteSelected('${category}')" ${selectedCount === 0 ? 'disabled' : ''}><i class="fas fa-trash mr-2"></i>선택 삭제 (${selectedCount})</button>
                                <button class="btn-red py-2 px-4 rounded-md text-sm" onclick="asClearCategoryData('${category}')"><i class="fas fa-eraser mr-2"></i>데이터 초기화</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="text" id="as-search-${category}" class="p-2 rounded modal-input" placeholder="검색..." onkeyup="asSearchCategory('${category}')">
                                <button class="btn-orange py-2 px-4 rounded-md" onclick="asClearSearch('${category}')">초기화</button>
                                <span id="as-search-total-quantity-${category}" class="text-sm text-yellow-300 font-semibold ml-2"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="btn-green py-2 px-4 rounded-md text-sm" onclick="asExport('${category}', true)">검색 결과 내보내기</button>
                                <button class="btn-green py-2 px-4 rounded-md text-sm" onclick="asExport('${category}', false)">현재탭 내보내기</button>
                                <button class="btn-orange py-2 px-4 rounded-md text-sm" onclick="asExportAllForCategory('${category}')">총 결과 내보내기</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="as-table-${category}" class="min-w-full text-sm text-white"></table>
                        </div>
                    </div>
                `;
                renderAsCategoryTable(category);
            }
        }

        function renderAsCategoryTable(category) {
            const tbl = document.getElementById(`as-table-${category}`);
            if (!tbl) return;
            const cfg = AS_CONFIG[category];
            const active = asState.activeSubTab[category];

            const searchQuery = document.getElementById(`as-search-${category}`)?.value.toLowerCase() || '';

            const rows = appData.as[category]
                .filter(item => {
                    const statusMatch = (active === 'completed' ? item.status === 'completed' : item.status !== 'completed');
                    if (!statusMatch) return false;
                    if (searchQuery) {
                        return Object.values(item).some(value => String(value).toLowerCase().includes(searchQuery));
                    }
                    return true;
                })
                .sort((a, b) => (+a['NO.'] || 0) - (+b['NO.'] || 0));

            const totalQuantity = rows.reduce((sum, item) => sum + (parseInt(item['수량']) || 0), 0);
            const quantityDisplay = document.getElementById(`as-search-total-quantity-${category}`);
            if (quantityDisplay) {
                if (searchQuery) {
                    quantityDisplay.textContent = `검색된 총 수량: ${totalQuantity.toLocaleString()}`;
                } else {
                    quantityDisplay.textContent = '';
                }
            }

            const allVisibleChecked = rows.length > 0 && rows.every(item => asState.selectedIds[category].has(item.id));

            const headCols = [
                `<input type="checkbox" onchange="asToggleSelectAll(event, '${category}')" ${allVisibleChecked ? 'checked' : ''}>`,
                '편집',
                '삭제',
                ...Object.keys(cfg.fields)
            ];

            const headerHtml = `<thead><tr>${headCols.map(h => `<th class="p-2 text-left">${h}</th>`).join('')}</tr></thead>`;

            const bodyHtml = rows.map(r => {
                const isSelected = asState.selectedIds[category].has(r.id);
                let completionCell = r['완료일'] || '';
                if (r.status !== 'completed') {
                    completionCell = `<button class="btn-green py-1 px-2 rounded text-xs" onclick="asOpenCompleteModal('${category}', '${r.id}')">완료 처리</button>`;
                }

                const cellsHtml = Object.entries(cfg.fields).map(([label, key]) => {
                    let value = r[key] || '';
                    let cellContent;

                    if (key === '완료일') {
                        cellContent = completionCell;
                    } else if (label === '호선번호' && value) {
                        const escapedHullNumber = psmEscapeHtml(value);
                        cellContent = `<a href="#" onclick="event.preventDefault(); showHullStatusModal('${escapedHullNumber}')" class="text-blue-300 hover:underline">${escapedHullNumber}</a>`;
                    } else {
                        cellContent = psmEscapeHtml(value);
                    }
                    return `<td class="p-2 whitespace-nowrap">${cellContent}</td>`;
                }).join('');

                return `
                <tr class="hover:bg-gray-700 ${isSelected ? 'bg-blue-900/50' : ''}">
                    <td class="p-2"><input type="checkbox" onchange="asToggleSelectOne(event,'${category}','${r.id}')" ${isSelected ? 'checked' : ''}></td>
                    <td class="p-2 text-center">
                        <button onclick="asOpenAddModal('${category}','${r.id}')" class="text-blue-400 hover:text-blue-300"><i class="fas fa-edit"></i></button>
                    </td>
                    <td class="p-2 text-center">
                        <button onclick="asDeleteSelectedRow('${category}','${r.id}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
                    </td>
                    ${cellsHtml}
                </tr>`;
            }).join('');

            tbl.innerHTML = headerHtml + `<tbody>${bodyHtml}</tbody>`;
        }

        function asDeleteSelectedRow(category, id) {
            asState.selectedIds[category] = new Set([id]);
            asDeleteSelected(category);
        }

        function renderAsCategoryChart(category) {
            const chartEl = document.getElementById(`as-chart-${category}`);
            if(!chartEl) return;

            const data = appData.as[category];
            let top10Data;
            let chartLabel;

            if (category === 'converter') {
                chartLabel = '컨버터 코드';
                const counts = data.reduce((acc, item) => {
                    if (item.컨버터코드) acc[item.컨버터코드] = (acc[item.컨버터코드] || 0) + (parseInt(item.수량) || 0);
                    return acc;
                }, {});
                top10Data = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 10);
            } else {
                chartLabel = '대체 자재 코드';
                const counts = data.reduce((acc, item) => {
                    if (item.대체자재코드) acc[item.대체자재코드] = (acc[item.대체자재코드] || 0) + (parseInt(item.수량) || 0);
                    return acc;
                }, {});
                top10Data = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 10);
            }

            if (asCharts[category]) asCharts[category].destroy();
            asCharts[category] = new Chart(chartEl, {
                type: 'bar',
                data: {
                    labels: top10Data.map(d => d[0]),
                    datasets: [{
                        label: `Top 10 ${chartLabel} 수량`,
                        data: top10Data.map(d => d[1]),
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: '#3b82f6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        y: { ticks: { color: '#e5e7eb' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#e5e7eb' }, grid: { color: '#374151' }, beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: `Top 10 ${chartLabel} 수량`, color: 'white', font: { size: 16 } },
                        datalabels: { color: 'white', anchor: 'end', align: 'end', formatter: (value) => value > 0 ? value : '' }
                    }
                }
            });
        }

        function renderAsIntegrated() {
            const container = document.getElementById('as-integrated-content');
            if (!container) return;

            const activeSubTab = asState.activeSubTab.integrated;
            container.innerHTML = `
                <div class="border-b border-gray-700 mb-4">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button onclick="asSetIntegratedSubTab('data')" class="as-sub-nav-btn ${activeSubTab === 'data' ? 'active' : ''}">데이터</button>
                        <button onclick="asSetIntegratedSubTab('analysis')" class="as-sub-nav-btn ${activeSubTab === 'analysis' ? 'active' : ''}">통합 분석</button>
                        <button onclick="asSetIntegratedSubTab('incomplete-list')" class="as-sub-nav-btn ${activeSubTab === 'incomplete-list' ? 'active' : ''}">미완료 제품 리스트</button>
                    </nav>
                </div>
                <div id="as-integrated-subcontent"></div>
            `;
            renderAsIntegratedSubContent();
        }

        function asSetIntegratedSubTab(subTab) {
            asState.activeSubTab.integrated = subTab;
            renderAsIntegratedSubContent();
        }

        function renderAsIntegratedSubContent() {
            const container = document.getElementById('as-integrated-subcontent');
            const activeSubTab = asState.activeSubTab.integrated;

            if (activeSubTab === 'analysis') {
                container.innerHTML = `<div class="glass-card p-6 h-96"><canvas id="as-chart-integrated"></canvas></div>`;
                renderAsIntegratedAnalysisChart();
            } else if (activeSubTab === 'incomplete-list') {
                container.innerHTML = `
                    <div class="glass-card p-6">
                        <div id="as-incomplete-list-integrated"></div>
                    </div>
                `;
                renderAsIncompleteList();
            } else {
                const selectedCount = asState.selectedIds.integrated.size;
                container.innerHTML = `
                    <div class="glass-card p-4">
                        <!-- 통합 불러오기 -->
                        <div class="mb-4 p-4 bg-gray-800 rounded-lg">
                            <div id="as-integrated-drop-zone" class="drag-drop-zone rounded-md" ondragover="handleIntegratedDragOver(event)" ondragleave="handleIntegratedDragLeave(event)" ondrop="handleIntegratedDrop(event)">
                                <p class="text-white font-semibold mb-2">통합 Excel 파일 불러오기</p>
                                <p class="text-sm text-gray-400 mb-3">파일을 업로드하면 자동으로 기타제품, 컨버터, 투광등으로 분류됩니다</p>
                                <input type="file" id="as-integrated-file-input" accept=".xlsx, .xls, .csv" class="hidden" onchange="asHandleIntegratedFileSelect(event)">
                                <button class="mt-3 btn-primary py-2 px-4 rounded text-sm" onclick="document.getElementById('as-integrated-file-input').click()">
                                    <i class="fas fa-file-upload mr-2"></i>통합 파일 선택
                                </button>
                            </div>
                        </div>

                        <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                            <div class="flex items-center gap-4">
                                <div class="isolate inline-flex rounded-md shadow-sm">
                                    <button onclick="asSetIntegratedStatusFilter('all')" class="relative inline-flex items-center rounded-l-md px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-600 hover:bg-gray-700 focus:z-10 ${asState.integratedStatusFilter === 'all' ? 'bg-blue-600' : 'bg-gray-800'}">전체</button>
                                    <button onclick="asSetIntegratedStatusFilter('incomplete')" class="relative -ml-px inline-flex items-center px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-600 hover:bg-gray-700 focus:z-10 ${asState.integratedStatusFilter === 'incomplete' ? 'bg-blue-600' : 'bg-gray-800'}">미완료</button>
                                    <button onclick="asSetIntegratedStatusFilter('completed')" class="relative -ml-px inline-flex items-center rounded-r-md px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-600 hover:bg-gray-700 focus:z-10 ${asState.integratedStatusFilter === 'completed' ? 'bg-blue-600' : 'bg-gray-800'}">완료</button>
                                </div>
                                <div class="isolate inline-flex rounded-md shadow-sm">
                                    <button onclick="asSetIntegratedFilter('all')" class="relative inline-flex items-center rounded-l-md px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-600 hover:bg-gray-700 focus:z-10 ${asState.integratedFilter === 'all' ? 'bg-blue-600' : 'bg-gray-800'}">전체</button>
                                    <button onclick="asSetIntegratedFilter('general')" class="relative -ml-px inline-flex items-center px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-600 hover:bg-gray-700 focus:z-10 ${asState.integratedFilter === 'general' ? 'bg-blue-600' : 'bg-gray-800'}">기타</button>
                                    <button onclick="asSetIntegratedFilter('converter')" class="relative -ml-px inline-flex items-center px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-600 hover:bg-gray-700 focus:z-10 ${asState.integratedFilter === 'converter' ? 'bg-blue-600' : 'bg-gray-800'}">컨버터</button>
                                    <button onclick="asSetIntegratedFilter('floodlight')" class="relative -ml-px inline-flex items-center rounded-r-md px-3 py-2 text-sm font-semibold ring-1 ring-inset ring-gray-600 hover:bg-gray-700 focus:z-10 ${asState.integratedFilter === 'floodlight' ? 'bg-blue-600' : 'bg-gray-800'}">투광등</button>
                                </div>
                                <button class="btn-red py-2 px-4 rounded-md text-sm" onclick="asDeleteSelected('integrated')" ${selectedCount === 0 ? 'disabled' : ''}><i class="fas fa-trash mr-2"></i>선택 삭제 (${selectedCount})</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="text" id="as-search-integrated" class="p-2 rounded modal-input" placeholder="통합 검색..." onkeyup="asSearchIntegrated()">
                                <button class="btn-orange py-2 px-4 rounded-md" onclick="asClearSearchIntegrated()">초기화</button>
                                <span id="as-search-total-quantity-integrated" class="text-sm text-yellow-300 font-semibold ml-2"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="btn-green py-2 px-4 rounded-md text-sm" onclick="asExportIntegrated(false)">전체 내보내기</button>
                                <button class="btn-green py-2 px-4 rounded-md text-sm" onclick="asExportIntegrated(true)">검색 결과 내보내기</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="as-table-integrated" class="min-w-full text-sm text-white"></table>
                        </div>
                    </div>
                `;
                renderAsIntegratedTable();
            }
        }

        // --- 통합 불러오기 함수들 ---
        function handleIntegratedDragOver(event) {
            event.preventDefault();
            document.getElementById('as-integrated-drop-zone').classList.add('dragover');
        }
        function handleIntegratedDragLeave(event) {
            event.preventDefault();
            document.getElementById('as-integrated-drop-zone').classList.remove('dragover');
        }
        function handleIntegratedDrop(event) {
            event.preventDefault();
            document.getElementById('as-integrated-drop-zone').classList.remove('dragover');
            const file = event.dataTransfer.files[0];
            if (file) asImportIntegratedFromExcel(file);
        }
        function asHandleIntegratedFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                asImportIntegratedFromExcel(file);
                event.target.value = '';
            }
        }

        async function asImportIntegratedFromExcel(file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                    if (!jsonData || jsonData.length === 0) {
                        showConfirm("파일에 데이터가 없습니다.", () => {});
                        return;
                    }

                    const categorizedData = { general: [], converter: [], floodlight: [] };
                    const importStats = { general: 0, converter: 0, floodlight: 0 };

                    console.log('엑셀 데이터 처리 시작:', jsonData.length, '개 행');

                    jsonData.forEach((row, index) => {
                        // 카테고리 결정 로직 - 엑셀 파일 구조에 맞게 수정
                        let category = null;
                        
                        // 1. 시스템 컬럼 우선 확인 (정확한 매칭)
                        if (row['시스템']) {
                            const systemValue = String(row['시스템']).trim();
                            console.log(`행 ${index + 1}: 시스템 = "${systemValue}"`);
                            
                            if (systemValue === '컨버터') {
                                category = 'converter';
                            } else if (systemValue === '투광등') {
                                category = 'floodlight';
                            } else if (systemValue === '기타제품') {
                                category = 'general';
                            }
                        }
                        
                        // 2. 시스템 컬럼이 없거나 인식되지 않은 경우 필드 기반 분류
                        if (!category) {
                            if (row['컨버터 번호'] || row['컨버터 코드'] || row['설치 위치']) {
                                category = 'converter';
                            } else if (row['제품명'] && String(row['제품명']).toLowerCase().includes('투광')) {
                                category = 'floodlight';
                            } else {
                                category = 'general';
                            }
                        }

                        console.log(`행 ${index + 1}: 최종 카테고리 = ${category}`);

                        const cfg = AS_CONFIG[category];
                        const newItem = { 
                            id: Date.now() + Math.random() * 1000 + index, 
                            status: 'incomplete' 
                        };

                        // 공통 필드 매핑
                        for (const header in cfg.fields) {
                            const key = cfg.fields[header];
                            let value = row[header] || '';
                            
                            if (key === '접수일' || key === '완료일') {
                                value = formatDate(value);
                            } else if (key === '수량') {
                                value = parseInt(value) || 0;
                            }
                            newItem[key] = value;
                        }
                        
                        // 상태 컬럼이 있는 경우 반영
                        if (row['상태']) {
                            const st = String(row['상태']).trim();
                            if (st === '완료' || st.toLowerCase() === 'completed' || st === 'Y') {
                                newItem.status = 'completed';
                                if (!newItem['완료일']) newItem['완료일'] = getTodayString();
                            }
                        } else if (newItem['완료일']) {
                            newItem.status = 'completed';
                        }

                        categorizedData[category].push(newItem);
                        importStats[category]++;
                    });

                    console.log('분류 결과:', importStats);

                    showLoading();
                    for (const category in categorizedData) {
                        if (categorizedData[category].length > 0) {
                            appData.as[category].push(...categorizedData[category]);
                            asReindex(category);
                            if (isOnline && firebaseReady) {
                                await saveBulkDataToFirebase(category, appData.as[category]);
                            }
                        }
                    }
                    hideLoading();

                    renderAsDashboard();
                    renderAsIntegrated();
                    Object.keys(AS_CONFIG).forEach(cat => {
                        if (document.getElementById(`as-${cat}-content`)) {
                            renderAsCategory(cat);
                        }
                    });

                    const message = `통합 데이터 가져오기 완료!\n기타제품: ${importStats.general}개\n컨버터: ${importStats.converter}개\n투광등: ${importStats.floodlight}개`;
                    showConfirm(message, () => {});
                    addRecentActivity('ASImport', `통합 A/S 데이터 가져옴`, `총 ${jsonData.length}개 항목`);
                } catch (error) {
                    console.error("통합 파일 처리 오류:", error);
                    showConfirm("파일 처리 중 오류가 발생했습니다. 파일 형식을 확인해주세요.", () => {});
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function asSetIntegratedFilter(filter) {
            asState.integratedFilter = filter;
            renderAsIntegratedSubContent();
        }
        function asSetIntegratedStatusFilter(filter) {
            asState.integratedStatusFilter = filter;
            renderAsIntegratedSubContent();
        }

        function renderAsIntegratedTable() {
            const tableContainer = document.getElementById(`as-table-integrated`);
            if (!tableContainer) return;

            const searchQuery = document.getElementById(`as-search-integrated`)?.value.toLowerCase() || '';

            let allData = [];
            Object.keys(AS_CONFIG).forEach(cat => {
                if (asState.integratedFilter === 'all' || asState.integratedFilter === cat) {
                    appData.as[cat].forEach(item => allData.push({ ...item, category: cat }));
                }
            });

            if (asState.integratedStatusFilter !== 'all') {
                allData = allData.filter(item => (
                    asState.integratedStatusFilter === 'completed'
                        ? item.status === 'completed'
                        : item.status !== 'completed'
                ));
            }

            if (searchQuery) {
                allData = allData.filter(item =>
                    Object.values(item).some(value => String(value).toLowerCase().includes(searchQuery))
                );
            }

            const totalQuantity = allData.reduce((sum, item) => sum + (parseInt(item['수량']) || 0), 0);
            const quantityDisplay = document.getElementById('as-search-total-quantity-integrated');
            if (quantityDisplay) {
                quantityDisplay.textContent = searchQuery ? `검색된 총 수량: ${totalQuantity.toLocaleString()}` : '';
            }

            allData.sort((a, b) => (parseInt(a['NO.']) || 0) - (parseInt(b['NO.']) || 0));

            const selectedIds = asState.selectedIds.integrated;
            const allVisibleChecked = allData.length > 0 && allData.every(item => selectedIds.has(item.id));

            const headers = ['<input type="checkbox" onchange="asToggleSelectAll(event, \'integrated\')" ' + (allVisibleChecked ? 'checked' : '') + '>', 'NO.', '시스템', '상태', '구분', '클레임 NO.', '호선번호', '불량 자재코드', '대체 자재 코드', '컨버터 번호', '컨버터 코드', '설치 위치', '제품명', '수량', '접수일', '완료일', '비고'];
            let headerHtml = `<thead><tr>${headers.map(h => `<th class="p-2 text-left">${h}</th>`).join('')}</tr></thead>`;

            let bodyHtml = `<tbody>${allData.map(item => {
                const isSelected = selectedIds.has(item.id);
                const categoryName = AS_CONFIG[item.category].name;
                const statusText = item.status === 'completed' ? '완료' : '미완료';
                const statusColor = item.status === 'completed' ? 'text-green-400' : 'text-red-400';

                let completionCell = item['완료일'] || '';
                if (item.status !== 'completed') {
                    completionCell = `<button class="btn-green py-1 px-2 rounded text-xs" onclick="asOpenCompleteModal('${item.category}', '${item.id}')">완료 처리</button>`;
                }

                const hullNumber = item['호선번호'] || '';
                let hullNumberCell;
                if (hullNumber) {
                    const escapedHullNumber = psmEscapeHtml(hullNumber);
                    hullNumberCell = `<a href="#" onclick="event.preventDefault(); showHullStatusModal('${escapedHullNumber}')" class="text-blue-300 hover:underline">${escapedHullNumber}</a>`;
                } else {
                    hullNumberCell = '';
                }

                return `<tr class="hover:bg-gray-700 ${isSelected ? 'bg-blue-900/50' : ''}">
                    <td class="p-2"><input type="checkbox" onchange="asToggleSelectOne(event, 'integrated', '${item.id}')" ${isSelected ? 'checked' : ''}></td>
                    <td class="p-2">${psmEscapeHtml(item['NO.'] || '')}</td>
                    <td class="p-2">${psmEscapeHtml(categoryName)}</td>
                    <td class="p-2"><span class="${statusColor}">${psmEscapeHtml(statusText)}</span></td>
                    <td class="p-2">${psmEscapeHtml(item['구분'] || '')}</td>
                    <td class="p-2">${psmEscapeHtml(item['클레임NO'] || '')}</td>
                    <td class="p-2">${hullNumberCell}</td>
                    <td class="p-2">${psmEscapeHtml(item['불량자재코드'] || '')}</td>
                    <td class="p-2">${psmEscapeHtml(item['대체자재코드'] || '')}</td>
                    <td class="p-2">${psmEscapeHtml(item['컨버터번호'] || '')}</td>
                    <td class="p-2">${psmEscapeHtml(item['컨버터코드'] || '')}</td>
                    <td class="p-2">${psmEscapeHtml(item['설치위치'] || '')}</td>
                    <td class="p-2">${psmEscapeHtml(item['제품명'] || '')}</td>
                    <td class="p-2">${psmEscapeHtml(item['수량'] || '')}</td>
                    <td class="p-2">${psmEscapeHtml(item['접수일'] || '')}</td>
                    <td class="p-2">${completionCell}</td>
                    <td class="p-2">${psmEscapeHtml(item['비고'] || '')}</td>
                </tr>`;
            }).join('')}</tbody>`;

            tableContainer.innerHTML = headerHtml + bodyHtml;
        }

        function renderAsIntegratedAnalysisChart() {
            const chartEl = document.getElementById('as-chart-integrated');
            if(!chartEl) return;

            const categoryStats = Object.keys(AS_CONFIG).map(cat => {
                const items = appData.as[cat];
                const catCompleted = items.filter(i => i.status === 'completed').length;
                const catIncomplete = items.length - catCompleted;
                return { name: AS_CONFIG[cat].name, completed: catCompleted, incomplete: catIncomplete };
            });

            if (asCharts.integrated) asCharts.integrated.destroy();
            asCharts.integrated = new Chart(chartEl, {
                type: 'bar',
                data: {
                    labels: categoryStats.map(s => s.name),
                    datasets: [
                        { label: '완료', data: categoryStats.map(s => s.completed), backgroundColor: 'rgba(16, 185, 129, 0.7)' },
                        { label: '미완료', data: categoryStats.map(s => s.incomplete), backgroundColor: 'rgba(239, 68, 68, 0.7)' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { stacked: true, ticks: { color: '#e5e7eb' } }, y: { stacked: true, ticks: { color: '#e5e7eb' } } },
                    plugins: {
                        title: { display: true, text: '제품군별 완료/미완료 건수', color: 'white', font: { size: 16 } },
                        legend: { position: 'bottom', labels: { color: '#e5e7eb' } },
                        datalabels: { color: 'white', formatter: (value) => value > 0 ? value : '' }
                    }
                }
            });
        }

        function renderAsIncompleteList() {
            const container = document.getElementById('as-incomplete-list-integrated');
            if (!container) return;

            const incompleteItems = [];
            Object.keys(AS_CONFIG).forEach(category => {
                const items = appData.as[category].filter(item => item.status === 'incomplete');
                items.forEach(item => incompleteItems.push({ category, categoryName: AS_CONFIG[category].name, ...item }));
            });

            const groupedItems = {
                general: incompleteItems.filter(item => item.category === 'general'),
                converter: incompleteItems.filter(item => item.category === 'converter'),
                floodlight: incompleteItems.filter(item => item.category === 'floodlight')
            };

            const generalStats = groupByCodeAndSort(groupedItems.general, '대체자재코드');
            const floodlightStats = groupByCodeAndSort(groupedItems.floodlight, '대체자재코드');
            const converterStats = groupByCodeAndSort(groupedItems.converter, '컨버터코드');

            let html = '<div class="max-w-7xl mx-auto space-y-6">';

            const totalIncomplete = incompleteItems.length;
            const totalGeneral = generalStats.reduce((sum, stat) => sum + stat.quantity, 0);
            const totalConverter = converterStats.reduce((sum, stat) => sum + stat.quantity, 0);
            const totalFloodlight = floodlightStats.reduce((sum, stat) => sum + stat.quantity, 0);

            html += `<div class="glass-card p-6">
                <h3 class="text-xl font-semibold text-white mb-4 flex items-center">
                    <i class="fas fa-exclamation-triangle mr-3 text-yellow-400"></i>미완료 제품 현황 요약
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-gray-700 bg-opacity-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-yellow-300">${totalIncomplete}</div>
                        <div class="text-gray-300 text-sm">전체 미완료 건수</div>
                    </div>
                    <div class="bg-gray-700 bg-opacity-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-300">${totalGeneral}</div>
                        <div class="text-gray-300 text-sm">기타제품 수량</div>
                    </div>
                    <div class="bg-gray-700 bg-opacity-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-300">${totalConverter}</div>
                        <div class="text-gray-300 text-sm">컨버터 수량</div>
                    </div>
                    <div class="bg-gray-700 bg-opacity-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-orange-300">${totalFloodlight}</div>
                        <div class="text-gray-300 text-sm">투광등 수량</div>
                    </div>
                </div>
            </div>`;

            html += '<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">';

            html += `<div class="glass-card p-6">
                <h4 class="text-lg font-semibold text-blue-300 mb-4 flex items-center">
                    <i class="fas fa-cog mr-2"></i>기타제품 (대체자재코드별)
                </h4>`;
            if (generalStats.length > 0) {
                html += `<div class="space-y-2 max-h-96 overflow-y-auto">`;
                generalStats.forEach(stat => {
                    html += `<div class="flex justify-between items-center p-3 bg-gray-700 bg-opacity-30 rounded text-sm border-l-4 border-blue-400">
                        <span class="text-gray-200 font-medium cursor-pointer hover:text-blue-300 transition-colors" onclick="showCodeDetailsModal('general', '${stat.code || 'N/A'}', '대체자재코드')">${stat.code || 'N/A'}</span>
                        <span class="text-yellow-300 font-bold">${stat.quantity}개</span>
                    </div>`;
                });
                html += `</div>`;
            } else {
                html += '<div class="text-center text-gray-400 py-8">미완료 기타제품이 없습니다.</div>';
            }
            html += '</div>';

            html += `<div class="glass-card p-6">
                <h4 class="text-lg font-semibold text-green-300 mb-4 flex items-center">
                    <i class="fas fa-microchip mr-2"></i>컨버터 (컨버터코드별)
                </h4>`;
            if (converterStats.length > 0) {
                html += `<div class="space-y-2 max-h-96 overflow-y-auto">`;
                converterStats.forEach(stat => {
                    html += `<div class="flex justify-between items-center p-3 bg-gray-700 bg-opacity-30 rounded text-sm border-l-4 border-green-400">
                        <span class="text-gray-200 font-medium cursor-pointer hover:text-green-300 transition-colors" onclick="showCodeDetailsModal('converter', '${stat.code || 'N/A'}', '컨버터코드')">${stat.code || 'N/A'}</span>
                        <span class="text-yellow-300 font-bold">${stat.quantity}개</span>
                    </div>`;
                });
                html += `</div>`;
            } else {
                html += '<div class="text-center text-gray-400 py-8">미완료 컨버터가 없습니다.</div>';
            }
            html += '</div>';

            html += `<div class="glass-card p-6">
                <h4 class="text-lg font-semibold text-orange-300 mb-4 flex items-center">
                    <i class="fas fa-lightbulb mr-2"></i>투광등 (대체자재코드별)
                </h4>`;
            if (floodlightStats.length > 0) {
                html += `<div class="space-y-2 max-h-96 overflow-y-auto">`;
                floodlightStats.forEach(stat => {
                    html += `<div class="flex justify-between items-center p-3 bg-gray-700 bg-opacity-30 rounded text-sm border-l-4 border-orange-400">
                        <span class="text-gray-200 font-medium cursor-pointer hover:text-orange-300 transition-colors" onclick="showCodeDetailsModal('floodlight', '${stat.code || 'N/A'}', '대체자재코드')">${stat.code || 'N/A'}</span>
                        <span class="text-yellow-300 font-bold">${stat.quantity}개</span>
                    </div>`;
                });
                html += `</div>`;
            } else {
                html += '<div class="text-center text-gray-400 py-8">미완료 투광등이 없습니다.</div>';
            }
            html += '</div>';

            html += '</div></div>';

            container.innerHTML = html;
        }

        function renderAsCategoryIncompleteList(category) {
            const container = document.getElementById(`as-incomplete-list-${category}`);
            if (!container) return;

            const incompleteItems = appData.as[category].filter(item => item.status === 'incomplete');

            let stats = [];
            let codeField = '';
            let title = '';
            let icon = '';
            let color = '';
            let borderColor = '';

            if (category === 'general') {
                codeField = '대체자재코드';
                title = '기타제품 미완료 리스트';
                icon = 'fas fa-cog';
                color = 'text-blue-300';
                borderColor = 'border-blue-400';
                stats = groupByCodeAndSort(incompleteItems, codeField);
            } else if (category === 'converter') {
                codeField = '컨버터코드';
                title = '컨버터 미완료 리스트';
                icon = 'fas fa-microchip';
                color = 'text-green-300';
                borderColor = 'border-green-400';
                stats = groupByCodeAndSort(incompleteItems, codeField);
            } else if (category === 'floodlight') {
                codeField = '대체자재코드';
                title = '투광등 미완료 리스트';
                icon = 'fas fa-lightbulb';
                color = 'text-orange-300';
                borderColor = 'border-orange-400';
                stats = groupByCodeAndSort(incompleteItems, codeField);
            }

            const totalQuantity = stats.reduce((sum, stat) => sum + stat.quantity, 0);
            const totalItems = incompleteItems.length;

            let html = '<div class="max-w-6xl mx-auto space-y-6">';

            html += `<div class="glass-card p-6">
                <h3 class="text-xl font-semibold ${color} mb-4 flex items-center">
                    <i class="${icon} mr-3"></i>${title}
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-700 bg-opacity-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-yellow-300">${totalItems}</div>
                        <div class="text-gray-300 text-sm">미완료 건수</div>
                    </div>
                    <div class="bg-gray-700 bg-opacity-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold ${color}">${totalQuantity}</div>
                        <div class="text-gray-300 text-sm">총 수량</div>
                    </div>
                    <div class="bg-gray-700 bg-opacity-50 p-4 rounded-lg text-center">
                        <div class="text-2xl font-bold text-white">${stats.length}</div>
                        <div class="text-gray-300 text-sm">코드 종류</div>
                    </div>
                </div>
            </div>`;

            if (stats.length > 0) {
                html += `<div class="glass-card p-6">
                    <h4 class="text-lg font-semibold text-white mb-4">코드별 상세 현황 (수량 많은 순)</h4>
                    <div class="space-y-3 max-h-96 overflow-y-auto">`;

                stats.forEach((stat, index) => {
                    const rankBadge = index < 3 ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                        index === 0 ? 'bg-yellow-500 text-black' :
                        index === 1 ? 'bg-gray-400 text-black' : 'bg-orange-500 text-white'
                    }">TOP ${index + 1}</span>` : '';

                    html += `<div class="flex justify-between items-center p-4 bg-gray-700 bg-opacity-30 rounded-lg border-l-4 ${borderColor}">
                        <div class="flex items-center space-x-3">
                            <span class="text-gray-200 font-medium text-lg cursor-pointer hover:${color} transition-colors" onclick="showCodeDetailsModal('${category}', '${stat.code || 'N/A'}', '${codeField}')">${stat.code || 'N/A'}</span>
                            ${rankBadge}
                        </div>
                        <span class="text-yellow-300 font-bold text-lg">${stat.quantity}개</span>
                    </div>`;
                });

                html += `</div></div>`;
            } else {
                html += `<div class="glass-card p-6">
                    <div class="text-center text-gray-400 py-12">
                        <i class="${icon} text-6xl mb-4"></i>
                        <div class="text-xl">미완료 제품이 없습니다.</div>
                        <div class="text-sm mt-2">모든 제품이 완료 처리되었습니다.</div>
                    </div>
                </div>`;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function showCodeDetailsModal(category, code, codeField) {
            if (!code || code === 'N/A') return;

            const items = appData.as[category].filter(item =>
                item.status === 'incomplete' && item[codeField] === code
            );

            if (items.length === 0) return;

            const categoryInfo = AS_CONFIG[category];
            let modalHtml = `
                <div class="modal-overlay" onclick="closeCodeDetailsModal(event)">
                    <div class="glass-card p-6 max-w-4xl mx-4 max-h-96 overflow-hidden" onclick="event.stopPropagation()">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-semibold text-white flex items-center">
                                <i class="fas ${category === 'general' ? 'fa-cog text-blue-300' :
                                              category === 'converter' ? 'fa-microchip text-green-300' :
                                              'fa-lightbulb text-orange-300'} mr-3"></i>
                                ${categoryInfo.name} - ${code} 상세 정보
                            </h3>
                            <button onclick="closeCodeDetailsModal()" class="text-gray-400 hover:text-white">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>

                        <div class="mb-4">
                            <div class="flex items-center space-x-6 text-sm text-gray-300">
                                <span><strong class="text-white">총 수량:</strong> ${items.reduce((sum, item) => sum + (parseInt(item['수량']) || 0), 0)}개</span>
                                <span><strong class="text-white">건수:</strong> ${items.length}건</span>
                            </div>
                        </div>

                        <div class="overflow-y-auto max-h-64">
                            <table class="min-w-full text-sm text-white">
                                <thead>
                                    <tr class="bg-gray-700 bg-opacity-50">
                                        <th class="p-3 text-left">호선번호</th>
                                        <th class="p-3 text-left">클레임 NO.</th>
                                        <th class="p-3 text-left">제품명</th>
                                        <th class="p-3 text-left">수량</th>
                                        <th class="p-3 text-left">접수일</th>
                                        <th class="p-3 text-left">비고</th>
                                    </tr>
                                </thead>
                                <tbody>`;

            items.forEach(item => {
                modalHtml += `
                    <tr class="border-b border-gray-700 hover:bg-gray-700 hover:bg-opacity-30">
                        <td class="p-3">${item['호선번호'] || '-'}</td>
                        <td class="p-3">${item['클레임NO'] || '-'}</td>
                        <td class="p-3">${item['제품명'] || '-'}</td>
                        <td class="p-3 font-semibold text-yellow-300">${item['수량'] || 0}</td>
                        <td class="p-3">${item['접수일'] || '-'}</td>
                        <td class="p-3 max-w-xs truncate" title="${item['비고'] || ''}">${item['비고'] || '-'}</td>
                    </tr>`;
            });

            modalHtml += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeCodeDetailsModal();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        function closeCodeDetailsModal(event) {
            if (event && event.target !== event.currentTarget) return;
            const modal = document.querySelector('.modal-overlay:not(#generic-modal):not(#confirm-modal)');
            if (modal) {
                modal.remove();
            }
        }

        function groupByCodeAndSort(items, codeField) {
            const codeMap = {};
            items.forEach(item => {
                const code = item[codeField] || 'N/A';
                const quantity = parseInt(item['수량']) || 0;
                if (!codeMap[code]) codeMap[code] = 0;
                codeMap[code] += quantity;
            });
            return Object.entries(codeMap)
                .map(([code, quantity]) => ({ code, quantity }))
                .sort((a, b) => b.quantity - a.quantity);
        }

        function asSearchCategory(category) { renderAsCategoryTable(category); }
        function asClearSearch(category) { document.getElementById(`as-search-${category}`).value = ''; renderAsCategoryTable(category); }
        function asSearchIntegrated() { renderAsIntegratedTable(); }
        function asClearSearchIntegrated() { document.getElementById(`as-search-integrated`).value = ''; renderAsIntegratedTable(); }

        function asToggleSelectAll(event, context) {
            const isChecked = event.target.checked;
            const selectedIds = asState.selectedIds[context];
            const searchQuery = document.getElementById(`as-search-${context}`)?.value.toLowerCase() || '';

            selectedIds.clear();

            if (isChecked) {
                let data;
                if (context === 'integrated') {
                    const filter = asState.integratedFilter;
                    const statusFilter = asState.integratedStatusFilter;
                    let allData = [];
                    Object.keys(AS_CONFIG).forEach(cat => {
                        if (filter === 'all' || filter === cat) {
                            allData.push(...appData.as[cat]);
                        }
                    });

                    if(statusFilter !== 'all') {
                        allData = allData.filter(item => statusFilter === 'completed' ? item.status === 'completed' : item.status !== 'completed');
                    }

                    if (searchQuery) {
                        allData = allData.filter(item => Object.values(item).some(value => String(value).toLowerCase().includes(searchQuery)));
                    }
                    data = allData;

                } else {
                    const subTab = asState.activeSubTab[context];
                    data = appData.as[context].filter(item => {
                        const statusMatch = (subTab === 'completed' && item.status === 'completed') || (subTab === 'incomplete' && item.status !== 'completed');
                        if (!statusMatch) return false;
                        if (searchQuery) {
                            return Object.values(item).some(value => String(value).toLowerCase().includes(searchQuery));
                        }
                        return true;
                    });
                }
                data.forEach(item => selectedIds.add(item.id));
            }

            if (context === 'integrated') renderAsIntegratedTable();
            else renderAsCategorySubContent(context);
        }

        function asToggleSelectOne(event, context, id) {
            const isChecked = event.target.checked;
            const selectedIds = asState.selectedIds[context];
            if (isChecked) selectedIds.add(id);
            else selectedIds.delete(id);
            if (context === 'integrated') renderAsIntegratedTable();
            else renderAsCategorySubContent(context);
        }

        function asHandleFileSelect(event, category) {
            const file = event.target.files[0];
            if (file) {
                asImportFromExcel(category, file);
                event.target.value = '';
            }
        }

        async function asImportFromExcel(category, file) {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                    if (!jsonData || jsonData.length === 0) {
                        showConfirm("파일에 데이터가 없습니다.", () => {});
                        return;
                    }

                    const config = AS_CONFIG[category];
                    const newItems = jsonData.map((row, index) => {
                        const newItem = { id: Date.now() + Math.random() * 1000 + index };
                        for (const header in config.fields) {
                            const key = config.fields[header];
                            let value = row[header] || '';
                            if (key === '접수일' || key === '완료일') {
                                value = formatDate(value);
                            } else if (key === '수량') {
                                value = parseInt(value) || 0;
                            }
                            newItem[key] = value;
                        }
                        newItem.status = newItem['완료일'] ? 'completed' : 'incomplete';
                        return newItem;
                    });

                    appData.as[category].push(...newItems);
                    asReindex(category);
                    
                    if (isOnline && firebaseReady) {
                        await saveBulkDataToFirebase(category, appData.as[category]);
                    }

                    renderAsCategory(category);
                    renderAsDashboard();
                    addRecentActivity('ASImport', `A/S(${config.name}) 데이터 가져옴`, `${newItems.length}개 항목`);
                } catch (error) {
                    console.error("A/S File processing error:", error);
                    showConfirm("파일 처리 중 오류가 발생했습니다. 파일 형식을 확인해주세요.", () => {});
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function asExport(category, filtered) {
            const config = AS_CONFIG[category];
            const activeSubTab = asState.activeSubTab[category];
            let dataToExport;

            if (filtered) {
                const searchQuery = document.getElementById(`as-search-${category}`)?.value.toLowerCase() || '';
                dataToExport = appData.as[category].filter(item => {
                    const statusMatch = (activeSubTab === 'incomplete' && item.status !== 'completed') || (activeSubTab === 'completed' && item.status === 'completed');
                    if (!statusMatch) return false;
                    return Object.values(item).some(value => String(value).toLowerCase().includes(searchQuery));
                });
            } else {
                dataToExport = appData.as[category].filter(item => (activeSubTab === 'incomplete' && item.status !== 'completed') || (activeSubTab === 'completed' && item.status === 'completed'));
            }

            if (dataToExport.length === 0) {
                showConfirm("내보낼 데이터가 없습니다.", () => {});
                return;
            }

            const headers = Object.keys(config.fields);
            const exportData = dataToExport.map(item => {
                const row = {};
                headers.forEach(h => row[h] = item[config.fields[h]]);
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `${config.name}_${activeSubTab}`);
            XLSX.writeFile(wb, `AS_${config.name}_${activeSubTab}_${getTodayString()}.xlsx`);
            addRecentActivity('ASExport', `A/S(${config.name}) 데이터 내보냄`, `${dataToExport.length}개 항목`);
        }

        function asExportAllForCategory(category) {
            const config = AS_CONFIG[category];
            const dataToExport = appData.as[category];

            if (dataToExport.length === 0) {
                showConfirm("내보낼 데이터가 없습니다.", () => {});
                return;
            }

            const headers = Object.keys(config.fields);
            const exportData = dataToExport.map(item => {
                const row = {};
                row['상태'] = item.status === 'completed' ? '완료' : '미완료';
                headers.forEach(h => row[h] = item[config.fields[h]]);
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `${config.name}_전체`);
            XLSX.writeFile(wb, `AS_${config.name}_전체_${getTodayString()}.xlsx`);
            addRecentActivity('ASExport', `A/S(${config.name}) 전체 데이터 내보냄`, `${dataToExport.length}개 항목`);
        }

        function asExportIntegrated(filtered) {
            let baseData = [];
            Object.keys(AS_CONFIG).forEach(cat => {
                if (asState.integratedFilter === 'all' || asState.integratedFilter === cat) {
                    baseData.push(...appData.as[cat].map(item => ({ ...item, category: cat })));
                }
            });

            if (asState.integratedStatusFilter !== 'all') {
                baseData = baseData.filter(item =>
                    asState.integratedStatusFilter === 'completed'
                        ? item.status === 'completed'
                        : item.status !== 'completed'
                );
            }

            let dataToExport = baseData;
            if (filtered) {
                const searchQuery = document.getElementById('as-search-integrated')?.value.toLowerCase() || '';
                if (searchQuery) {
                    dataToExport = baseData.filter(item =>
                        Object.values(item).some(value => String(value).toLowerCase().includes(searchQuery))
                    );
                }
            }

            if (dataToExport.length === 0) {
                showConfirm("내보낼 데이터가 없습니다.", () => {});
                return;
            }

            const exportData = dataToExport.map(item => ({
                '시스템': AS_CONFIG[item.category].name,
                '상태': item.status === 'completed' ? '완료' : '미완료',
                'NO.': item['NO.'],
                '구분': item['구분'],
                '클레임 NO.': item['클레임NO'],
                '호선번호': item['호선번호'],
                '불량 자재코드': item['불량자재코드'],
                '대체 자재 코드': item['대체자재코드'],
                '컨버터 번호': item['컨버터번호'],
                '컨버터 코드': item['컨버터코드'],
                '설치 위치': item['설치위치'],
                '제품명': item['제품명'],
                '수량': item['수량'],
                '접수일': item['접수일'],
                '완료일': item['완료일'],
                '비고': item['비고']
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'AS_통합');
            XLSX.writeFile(wb, `AS_통합_${getTodayString()}.xlsx`);
            addRecentActivity('ASExport', `A/S 통합 데이터 내보냄`, `${dataToExport.length}개 항목`);
        }

        function asOpenAddModal(category, id = null) {
            const cfg = AS_CONFIG[category];
            currentModalType = `as-${category}`;
            currentEditId = id;
            const isEdit = !!id;
            const item = isEdit ? appData.as[category].find(i => i.id == id) : {};

            const autocompleteFields = {
                general: ['불량자재코드', '대체자재코드'],
                converter: ['컨버터번호', '컨버터코드'],
                floodlight: ['불량자재코드', '대체자재코드']
            };
            const fieldsForCategory = autocompleteFields[category] || [];

            let fieldsHtml = '';
            Object.entries(cfg.fields).forEach(([label, key]) => {
                if (key === '완료일' || key === 'NO.') return;

                const val = item[key] || '';
                const ipType = key === '수량' ? 'number' : (key === '접수일' ? 'date' : 'text');

                if (fieldsForCategory.includes(key)) {
                    const datalistId = `datalist-${key.replace(/\s/g, '-')}`;
                    const uniqueValues = [...new Set(appData.as[category].map(i => i[key]).filter(Boolean))];
                    const datalistHtml = `<datalist id="${datalistId}">${uniqueValues.map(v => `<option value="${v}"></option>`).join('')}</datalist>`;

                    fieldsHtml += `
                    <div class="mb-3">
                        <label class="block mb-1 text-sm">${label}</label>
                        <input id="modal-${key}" type="text" value="${val}" list="${datalistId}" class="modal-input w-full p-2 rounded" autocomplete="off">
                        ${datalistHtml}
                    </div>`;
                } else {
                    fieldsHtml += `
                    <div class="mb-3">
                        <label class="block mb-1 text-sm">${label}</label>
                        <input id="modal-${key}" type="${ipType}" value="${val}" class="modal-input w-full p-2 rounded">
                    </div>`;
                }
            });

            const noValue = isEdit ? (item['NO.'] || '') : asGetNextNo(category);
            document.getElementById('generic-modal').innerHTML = `
            <div class="glass-card p-6 w-full max-w-xl mx-4 text-white">
                <h2 class="text-xl font-bold mb-4">${cfg.name} A/S ${isEdit ? '편집' : '추가'}</h2>
                <p class="mb-3 text-sm"><b>NO.</b> : ${noValue}</p>
                <div class="grid md:grid-cols-2 gap-4">${fieldsHtml}</div>
                <div class="flex justify-end gap-3 mt-6">
                    <button onclick="closeModal()" class="bg-gray-600 hover:bg-gray-500 px-4 py-2 rounded">취소</button>
                    <button onclick="asSaveItem()" class="btn-primary px-4 py-2 rounded">저장</button>
                </div>
            </div>`;
            document.getElementById('generic-modal').style.display = 'flex';
        }

        async function asSaveItem() {
            const category = currentModalType.split('-')[1];
            const cfg = AS_CONFIG[category];
            const isEdit = !!currentEditId;
            const id = isEdit ? currentEditId : Date.now();
            let item = isEdit ? {...appData.as[category].find(i => i.id == id)} : {id, status: 'incomplete'};

            if(!isEdit) item['NO.'] = asGetNextNo(category);

            Object.values(cfg.fields).forEach(key => {
                if(['NO.', '완료일'].includes(key)) return;
                const ip = document.getElementById(`modal-${key}`);
                if(ip) item[key] = key === '수량' ? parseInt(ip.value || 0) : ip.value;
            });

            if(isEdit){
                const idx = appData.as[category].findIndex(i => i.id == id);
                appData.as[category][idx] = item;
            } else {
                appData.as[category].push(item);
            }

            try {
                if (isOnline && firebaseReady) {
                    await saveItemToFirebase(category, item);
                }
                asReindex(category);
                if (isOnline && firebaseReady) {
                    await saveBulkDataToFirebase(category, appData.as[category]);
                }
            } catch (error) {
                console.error('저장 오류:', error);
                showConfirm('온라인 저장에 실패했습니다. 인터넷 연결을 확인해주세요.', () => {});
            }

            closeModal();
            renderAsCategory(category);
            renderAsDashboard();
            renderAsIntegrated();

            if (asState.activeSubTab[category] === 'incomplete-list') {
                renderAsCategoryIncompleteList(category);
            }
            if (asState.activeSubTab.integrated === 'incomplete-list') {
                renderAsIncompleteList();
            }
        }

        function asOpenCompleteModal(category, id) {
            const item = appData.as[category].find(i => i.id == id);
            if (!item) return;

            currentModalType = `as-complete-${category}`;
            currentEditId = id;

            const modal = document.getElementById('generic-modal');
            modal.innerHTML = `
                <div class="glass-card p-6 w-full max-w-md mx-4 text-white">
                    <h2 class="text-xl font-bold mb-6">A/S 완료 처리</h2>
                    <p class="mb-4"><strong>클레임 NO:</strong> ${item['클레임NO'] || 'N/A'}</p>
                    <div class="mb-4">
                        <label class="block mb-1 text-sm">완료일</label>
                        <input type="date" id="modal-complete-date" value="${getTodayString()}" class="p-2 rounded w-full modal-input">
                    </div>
                    <div class="mb-4">
                        <label class="block mb-1 text-sm">비고 (추가)</label>
                        <textarea id="modal-complete-notes" rows="3" class="p-2 rounded w-full modal-input"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="closeModal()" class="py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500">취소</button>
                        <button onclick="asCompleteItem()" class="py-2 px-4 rounded-md btn-primary">완료 저장</button>
                    </div>
                </div>`;
            modal.style.display = 'flex';
        }

        async function asCompleteItem() {
            if (!currentModalType.startsWith('as-complete-')) return;
            const category = currentModalType.split('-')[2];
            const config = AS_CONFIG[category];

            const item = appData.as[category].find(i => i.id == currentEditId);
            if (!item) return;

            item.status = 'completed';
            item['완료일'] = document.getElementById('modal-complete-date').value;
            const newNotes = document.getElementById('modal-complete-notes').value;
            if (newNotes) {
                item['비고'] = item['비고'] ? `${item['비고']}\n[${item['완료일']}] ${newNotes}` : `[${item['완료일']}] ${newNotes}`;
            }

            try {
                if (isOnline && firebaseReady) {
                    await saveItemToFirebase(category, item);
                }
            } catch (error) {
                console.error('완료 처리 저장 오류:', error);
                showConfirm('온라인 저장에 실패했습니다. 인터넷 연결을 확인해주세요.', () => {});
            }

            closeModal();

            if (asState.activeTab === 'integrated') {
                renderAsIntegratedTable();
                if (asState.activeSubTab.integrated === 'incomplete-list') {
                    renderAsIncompleteList();
                }
            } else {
                renderAsCategoryTable(category);
                if (asState.activeSubTab[category] === 'incomplete-list') {
                    renderAsCategoryIncompleteList(category);
                }
            }
            renderAsDashboard();
            addRecentActivity('ASComplete', `A/S(${config.name}) 완료 처리됨`, item['클레임NO'] || item['제품명']);
        }

        function asDeleteSelected(context) {
            const selectedIds = asState.selectedIds[context];
            if (selectedIds.size === 0) return;

            showConfirm(`${selectedIds.size}개의 A/S 항목을 정말 삭제하시겠습니까?`, async () => {
                let deletedCount = 0;
                let categoriesToReindex = new Set();

                showLoading();
                try {
                    if (context === 'integrated') {
                        for (const id of selectedIds) {
                            for (const category of Object.keys(AS_CONFIG)) {
                                const index = appData.as[category].findIndex(item => item.id == id);
                                if (index > -1) {
                                    if (isOnline && firebaseReady) {
                                        await deleteItemFromFirebase(category, id);
                                    }
                                    appData.as[category].splice(index, 1);
                                    categoriesToReindex.add(category);
                                    deletedCount++;
                                    break;
                                }
                            }
                        }
                    } else {
                        for (const id of selectedIds) {
                            if (isOnline && firebaseReady) {
                                await deleteItemFromFirebase(context, id);
                            }
                        }
                        appData.as[context] = appData.as[context].filter(item => !selectedIds.has(item.id));
                        categoriesToReindex.add(context);
                        deletedCount = selectedIds.size;
                    }

                    for (const cat of categoriesToReindex) {
                        asReindex(cat);
                        if (isOnline && firebaseReady) {
                            await saveBulkDataToFirebase(cat, appData.as[cat]);
                        }
                    }
                } catch (error) {
                    console.error('삭제 오류:', error);
                    showConfirm('온라인 삭제에 실패했습니다. 인터넷 연결을 확인해주세요.', () => {});
                } finally {
                    hideLoading();
                }

                selectedIds.clear();

                if (context === 'integrated') {
                    renderAsIntegrated();
                    if (asState.activeSubTab.integrated === 'incomplete-list') {
                        renderAsIncompleteList();
                    }
                } else {
                    renderAsCategory(context);
                    if (asState.activeSubTab[context] === 'incomplete-list') {
                        renderAsCategoryIncompleteList(context);
                    }
                }

                renderAsDashboard();
                addRecentActivity('AS', `A/S 항목 삭제됨`, `${deletedCount}개`);
            });
        }

        function asClearCategoryData(category) {
            const config = AS_CONFIG[category];
            showConfirm(`${config.name}의 모든 데이터를 정말 삭제하시겠습니까?`, async () => {
                showLoading();
                try {
                    if (isOnline && firebaseReady) {
                        await clearCategoryInFirebase(category);
                    }
                    appData.as[category] = [];
                } catch (error) {
                    console.error('데이터 초기화 오류:', error);
                    showConfirm('온라인 데이터 초기화에 실패했습니다. 인터넷 연결을 확인해주세요.', () => {});
                } finally {
                    hideLoading();
                }

                renderAsCategory(category);
                renderAsDashboard();

                if (asState.activeSubTab[category] === 'incomplete-list') {
                    renderAsCategoryIncompleteList(category);
                }
                if (asState.activeSubTab.integrated === 'incomplete-list') {
                    renderAsIncompleteList();
                }
                addRecentActivity('AS', `${config.name} 데이터 초기화됨`, '');
            });
        }

        function showHullStatusModal(hullNumber) {
            const allIncompleteItems = [];
            Object.keys(AS_CONFIG).forEach(category => {
                const items = appData.as[category].filter(item => {
                    return String(item['호선번호'] || '').trim() === String(hullNumber || '').trim()
                           && item.status !== 'completed';
                });
                items.forEach(item => {
                    allIncompleteItems.push({
                        ...item,
                        categoryName: AS_CONFIG[category].name
                    });
                });
            });

            allIncompleteItems.sort((a, b) => new Date(a['접수일']) - new Date(b['접수일']));

            let tableRowsHtml = '';
            if (allIncompleteItems.length > 0) {
                tableRowsHtml = allIncompleteItems.map(item => {
                    const materialCode = item['불량자재코드'] || item['컨버터코드'] || 'N/A';
                    return `
                        <tr class="hover:bg-gray-700">
                            <td class="p-2">${psmEscapeHtml(item.categoryName)}</td>
                            <td class="p-2">${psmEscapeHtml(item['접수일'])}</td>
                            <td class="p-2">${psmEscapeHtml(item['클레임NO'] || '')}</td>
                            <td class="p-2">${psmEscapeHtml(item['제품명'])}</td>
                            <td class="p-2">${psmEscapeHtml(materialCode)}</td>
                            <td class="p-2">${psmEscapeHtml(item['수량'])}</td>
                            <td class="p-2">${psmEscapeHtml(item['비고'])}</td>
                        </tr>
                    `;
                }).join('');
            } else {
                tableRowsHtml = `<tr><td colspan="7" class="p-6 text-center text-gray-400">해당 호선에 대한 미완료 A/S 항목이 없습니다.</td></tr>`;
            }

            const modalHtml = `
                <div class="glass-card p-6 w-full max-w-5xl mx-4 text-white rounded-lg shadow-xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">호선별 미완료 현황: ${psmEscapeHtml(hullNumber)}</h2>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
                    </div>
                    <div class="overflow-y-auto max-h-[60vh]">
                        <table class="min-w-full text-sm text-white">
                            <thead>
                                <tr class="text-left">
                                    <th class="p-2">시스템</th>
                                    <th class="p-2">접수일</th>
                                    <th class="p-2">클레임 NO.</th>
                                    <th class="p-2">제품명</th>
                                    <th class="p-2">자재코드</th>
                                    <th class="p-2">수량</th>
                                    <th class="p-2">비고</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRowsHtml}
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button onclick="closeModal()" class="py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500">닫기</button>
                    </div>
                </div>
            `;

            const modalContainer = document.getElementById('generic-modal');
            modalContainer.innerHTML = modalHtml;
            modalContainer.style.display = 'flex';
        }

        function handleDragOver(event, category) {
            event.preventDefault();
            document.getElementById(`as-drop-zone-${category}`).classList.add('dragover');
        }
        function handleDragLeave(event, category) {
            event.preventDefault();
            document.getElementById(`as-drop-zone-${category}`).classList.remove('dragover');
        }
        function handleDrop(event, category) {
            event.preventDefault();
            document.getElementById(`as-drop-zone-${category}`).classList.remove('dragover');
            const file = event.dataTransfer.files[0];
            if (file) asImportFromExcel(category, file);
        }

        function closeModal() {
            document.getElementById('generic-modal').style.display = 'none';
        }

        function showConfirm(text, callback) {
            const modal = document.getElementById('confirm-modal');
            modal.querySelector('#confirm-modal-text').textContent = text;
            modal.style.display = 'flex';
            confirmCallback = callback;
        }
        function hideConfirm() {
            const confirmModal = document.getElementById('confirm-modal');
            if(confirmModal) confirmModal.style.display = 'none';
            confirmCallback = null;
        }

        function downloadHTML() {
            const fullHtml = '<!DOCTYPE html>\n' + document.documentElement.outerHTML;
            const blob = new Blob([fullHtml], { type: 'text/html;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'AS통합관리시스템_스냅샷.html';
            a.click();
            URL.revokeObjectURL(a.href);
            addRecentActivity('System', 'HTML 스냅샷 다운로드됨', '');
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('confirm-ok-btn').addEventListener('click', () => {
                if (confirmCallback) confirmCallback();
                hideConfirm();
            });
            document.getElementById('confirm-cancel-btn').addEventListener('click', hideConfirm);

            // Firebase 초기화 및 데이터 로드
            showLoading();
            const firebaseInitialized = await initFirebase();
            if (firebaseInitialized) {
                await loadAllDataFromFirebase();
            } else {
                showConfirm("Firebase 연결에 실패했습니다. 오프라인 모드로 실행됩니다.", () => {});
            }
            hideLoading();

            // Register Chart.js plugins
            Chart.register(ChartDataLabels);

            // Show dashboard by default
            showAsSubTab('dashboard');

            // 온라인/오프라인 상태 모니터링
            window.addEventListener('online', async () => {
                console.log('온라인 상태로 변경됨');
                const reconnected = await initFirebase();
                if (reconnected) {
                    // 온라인 복구 시 데이터 동기화
                    await loadAllDataFromFirebase();
                    // 현재 화면 갱신
                    if (asState.activeTab === 'dashboard') {
                        renderAsDashboard();
                    } else if (asState.activeTab === 'integrated') {
                        renderAsIntegrated();
                    } else {
                        renderAsCategory(asState.activeTab);
                    }
                }
            });

            window.addEventListener('offline', () => {
                console.log('오프라인 상태로 변경됨');
                updateConnectionStatus(false);
            });

            // Firebase ready 이벤트 리스너
            window.addEventListener('firebaseReady', () => {
                console.log('Firebase 준비 완료');
                updateConnectionStatus(navigator.onLine);
            });

            // 초기 연결 상태 확인
            updateConnectionStatus(navigator.onLine && firebaseReady);

            // Keyboard shortcuts
            document.addEventListener('keydown', (event) => {
                if (event.ctrlKey || event.metaKey) {
                    if(asState.activeCategory) {
                        if (event.key === 'o') {
                            event.preventDefault();
                            document.getElementById(`as-file-input-${asState.activeCategory}`)?.click();
                        }
                        if (event.key === 'e') {
                            event.preventDefault();
                            asExport(asState.activeCategory, false);
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
