<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A/S 통합 관리 시스템</title>
    <!-- Tailwind CSS 3.4.1 CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome 6 CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js 3.9.1 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- Chart.js DataLabels Plugin 2.2.0 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <!-- SheetJS xlsx 0.18.5 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #e5e7eb;
        }
        .glass-card {
            background: rgba(31, 41, 55, 0.5);
            border-radius: 1rem;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(75, 85, 99, 0.5);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .hover-lift {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.15);
        }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-green { background-color: #10b981; color: white; }
        .btn-green:hover { background-color: #059669; }
        .btn-orange { background-color: #f59e0b; color: white; }
        .btn-orange:hover { background-color: #d97706; }
        .btn-red { background-color: #ef4444; color: white; }
        .btn-red:hover { background-color: #dc2626; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }
        .modal-input {
            color: white;
            background-color: rgba(55, 65, 81, 0.7);
            border: 1px solid #4b5563;
        }
        .modal-input::placeholder { color: #9ca3af; }
        .modal-input:focus {
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6;
            border-color: #3b82f6;
        }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        th { background-color: rgba(55, 65, 81, 0.5); color: #d1d5db; }
        tr:nth-child(even) { background-color: rgba(55, 65, 81, 0.2); }

        .drag-drop-zone {
            border: 2px dashed rgba(107, 114, 128, 0.5);
            padding: 20px; text-align: center; cursor: pointer;
            transition: background-color 0.3s;
        }
        .drag-drop-zone.dragover { background-color: rgba(75, 85, 99, 0.4); }

        .as-sub-nav-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, color 0.2s;
            border-bottom: 3px solid transparent;
        }
        .as-sub-nav-btn.active {
            background-color: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border-bottom-color: #3b82f6;
        }
        .as-sub-tab-content { display: none; }
        .as-sub-tab-content.active { display: block; }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="min-h-screen p-6">
        <!-- Header -->
        <header class="mb-6 glass-card p-5">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-tools text-2xl text-blue-400"></i>
                    <h1 class="text-2xl font-bold text-white">A/S 통합 관리 시스템</h1>
                    <div id="connection-status" class="ml-4 text-sm"></div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="downloadHTML()" class="py-2 px-4 rounded-md btn-primary text-sm">
                        <i class="fas fa-download mr-2"></i>현재 상태 저장 (HTML)
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="glass-card p-6">
            <!-- Sub-navigation -->
            <div class="mb-6">
                <div class="border-b border-gray-700">
                    <nav id="as-sub-nav" class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button onclick="showAsSubTab('dashboard')" class="as-sub-nav-btn" data-tab="dashboard">대시보드</button>
                        <button onclick="showAsSubTab('general')" class="as-sub-nav-btn" data-tab="general">기타제품</button>
                        <button onclick="showAsSubTab('converter')" class="as-sub-nav-btn" data-tab="converter">컨버터</button>
                        <button onclick="showAsSubTab('floodlight')" class="as-sub-nav-btn" data-tab="floodlight">투광등</button>
                        <button onclick="showAsSubTab('integrated')" class="as-sub-nav-btn" data-tab="integrated">통합 보기</button>
                    </nav>
                </div>
            </div>

            <!-- Sub-tab content -->
            <div id="as-dashboard-content" class="as-sub-tab-content"></div>
            <div id="as-general-content" class="as-sub-tab-content"></div>
            <div id="as-converter-content" class="as-sub-tab-content"></div>
            <div id="as-floodlight-content" class="as-sub-tab-content"></div>
            <div id="as-integrated-content" class="as-sub-tab-content"></div>
        </main>
    </div>

    <!-- Modals -->
    <div id="generic-modal" class="modal-overlay" style="display: none;"></div>
    <div id="confirm-modal" class="modal-overlay" style="display: none;">
        <div class="glass-card p-6 w-full max-w-sm mx-4 text-white">
            <h2 class="text-xl font-bold mb-4">확인</h2>
            <p id="confirm-modal-text" class="mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="py-2 px-4 rounded-md bg-gray-600 hover:bg-gray-500">취소</button>
                <button id="confirm-ok-btn" class="py-2 px-4 rounded-md btn-red">확인</button>
            </div>
        </div>
    </div>

    <script>
        // --- Global State ---
        const appData = {
            as: {
                general: [],
                converter: [],
                floodlight: []
            },
            recentActivities: []
        };

        let asCharts = { dashboard: null, general: null, converter: null, floodlight: null, integrated: null };
        let currentModalType = null, currentEditId = null, confirmCallback = null;

        // --- A/S State ---
        const asState = {
            activeTab: 'dashboard',
            activeCategory: 'general',
            activeSubTab: {
                general: 'incomplete',
                converter: 'incomplete',
                floodlight: 'incomplete',
                integrated: 'data'
            },
            selectedIds: {
                general: new Set(),
                converter: new Set(),
                floodlight: new Set(),
                integrated: new Set()
            },
            integratedFilter: 'all',
            integratedStatusFilter: 'all'
        };

        // --- Config - 원본과 동일한 한글 키 사용 ---
        const AS_CONFIG = {
            general: { 
                name: '기타제품', 
                fields: { 
                    'NO.': 'NO.', 
                    '구분': '구분', 
                    '클레임 NO.': '클레임NO', 
                    '호선번호': '호선번호', 
                    '불량 자재코드': '불량자재코드', 
                    '대체 자재 코드': '대체자재코드', 
                    '제품명': '제품명', 
                    '수량': '수량', 
                    '접수일': '접수일', 
                    '완료일': '완료일', 
                    '비고': '비고' 
                } 
            },
            converter: { 
                name: '컨버터', 
                fields: { 
                    'NO.': 'NO.', 
                    '구분': '구분', 
                    '클레임 NO.': '클레임NO', 
                    '호선번호': '호선번호', 
                    '컨버터 번호': '컨버터번호', 
                    '컨버터 코드': '컨버터코드', 
                    '설치 위치': '설치위치', 
                    '제품명': '제품명', 
                    '수량': '수량', 
                    '접수일': '접수일', 
                    '완료일': '완료일', 
                    '비고': '비고' 
                } 
            },
            floodlight: { 
                name: '투광등', 
                fields: { 
                    'NO.': 'NO.', 
                    '구분': '구분', 
                    '클레임 NO.': '클레임NO', 
                    '호선번호': '호선번호', 
                    '불량 자재코드': '불량자재코드', 
                    '대체 자재 코드': '대체자재코드', 
                    '제품명': '제품명', 
                    '수량': '수량', 
                    '접수일': '접수일', 
                    '완료일': '완료일', 
                    '비고': '비고' 
                } 
            }
        };

        // DB 필드 매핑
        const DB_FIELD_MAP = {
            general: {
                'NO.': 'no',
                '구분': 'division',
                '클레임NO': 'claim_no',
                '호선번호': 'hull_number',
                '불량자재코드': 'defective_material_code',
                '대체자재코드': 'alternative_material_code',
                '제품명': 'product_name',
                '수량': 'quantity',
                '접수일': 'receipt_date',
                '완료일': 'completion_date',
                '비고': 'notes'
            },
            converter: {
                'NO.': 'no',
                '구분': 'division',
                '클레임NO': 'claim_no',
                '호선번호': 'hull_number',
                '컨버터번호': 'converter_number',
                '컨버터코드': 'converter_code',
                '설치위치': 'installation_location',
                '제품명': 'product_name',
                '수량': 'quantity',
                '접수일': 'receipt_date',
                '완료일': 'completion_date',
                '비고': 'notes'
            },
            floodlight: {
                'NO.': 'no',
                '구분': 'division',
                '클레임NO': 'claim_no',
                '호선번호': 'hull_number',
                '불량자재코드': 'defective_material_code',
                '대체자재코드': 'alternative_material_code',
                '제품명': 'product_name',
                '수량': 'quantity',
                '접수일': 'receipt_date',
                '완료일': 'completion_date',
                '비고': 'notes'
            }
        };

        // --- API Functions ---
        const API_BASE = '';

        async function apiCall(endpoint, options = {}) {
            try {
                updateConnectionStatus(true);
                const response = await fetch(API_BASE + endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || `HTTP ${response.status}`);
                }

                updateConnectionStatus(false);
                return await response.json();
            } catch (error) {
                updateConnectionStatus(false, true);
                console.error('API Error:', error);
                throw error;
            }
        }

        function updateConnectionStatus(loading = false, error = false) {
            const statusEl = document.getElementById('connection-status');
            if (loading) {
                statusEl.innerHTML = '<div class="loading"></div> <span class="text-yellow-300">연결 중...</span>';
            } else if (error) {
                statusEl.innerHTML = '<i class="fas fa-exclamation-triangle text-red-400"></i> <span class="text-red-400">연결 오류</span>';
            } else {
                statusEl.innerHTML = '<i class="fas fa-check-circle text-green-400"></i> <span class="text-green-400">연결됨</span>';
            }
        }

        // DB 데이터를 프론트엔드 형식으로 변환
        function dbToFrontend(dbItem, category) {
            const item = { id: dbItem.id, status: dbItem.status };
            const fieldMap = DB_FIELD_MAP[category];
            
            for (const [frontendKey, dbKey] of Object.entries(fieldMap)) {
                item[frontendKey] = dbItem[dbKey] || '';
            }
            
            return item;
        }

        // 프론트엔드 데이터를 DB 형식으로 변환
        function frontendToDb(frontendItem, category) {
            const dbItem = { status: frontendItem.status || 'incomplete' };
            const fieldMap = DB_FIELD_MAP[category];
            
            for (const [frontendKey, dbKey] of Object.entries(fieldMap)) {
                if (frontendItem[frontendKey] !== undefined) {
                    dbItem[dbKey] = frontendItem[frontendKey];
                }
            }
            
            return dbItem;
        }

        async function loadAllData() {
            try {
                const promises = Object.keys(AS_CONFIG).map(async category => {
                    const dbData = await apiCall(`/api/data/${category}`);
                    appData.as[category] = dbData.map(item => dbToFrontend(item, category));
                });

                const activities = await apiCall('/api/activities');
                appData.recentActivities = activities;

                await Promise.all(promises);
            } catch (error) {
                console.error('데이터 로드 실패:', error);
                showConfirm('서버에서 데이터를 불러올 수 없습니다. 연결을 확인해주세요.', () => {});
            }
        }

        async function saveItem(category, item) {
            const dbItem = frontendToDb(item, category);
            
            if (item.id && item.id > 0) {
                const result = await apiCall(`/api/data/${category}/${item.id}`, {
                    method: 'PUT',
                    body: JSON.stringify(dbItem)
                });
                return dbToFrontend({id: item.id, ...result}, category);
            } else {
                const result = await apiCall(`/api/data/${category}`, {
                    method: 'POST',
                    body: JSON.stringify(dbItem)
                });
                return dbToFrontend(result, category);
            }
        }

        async function deleteItem(category, id) {
            return await apiCall(`/api/data/${category}/${id}`, {
                method: 'DELETE'
            });
        }

        async function clearCategoryData(category) {
            return await apiCall(`/api/data/${category}`, {
                method: 'DELETE'
            });
        }

        async function bulkSave(category, items, clearFirst = false) {
            const dbItems = items.map(item => frontendToDb(item, category));
            return await apiCall(`/api/bulk/${category}`, {
                method: 'POST',
                body: JSON.stringify({ items: dbItems, clearFirst })
            });
        }

        async function reindexCategory(category) {
            return await apiCall(`/api/reindex/${category}`, {
                method: 'POST'
            });
        }

        function asReindex(category) {
            const list = appData.as[category];
            list.sort((a, b) => (parseInt(a['NO.']) || 0) - (parseInt(b['NO.']) || 0));
            list.forEach((item, idx) => {
                item['NO.'] = idx + 1;
            });
        }

        function asGetNextNo(category) {
            const list = appData.as[category];
            return list.length ? Math.max(...list.map(i => +i['NO.'] || 0)) + 1 : 1;
        }

        async function addRecentActivity(type, message, itemName) {
            const icons = {
                'AS': 'fas fa-tools',
                'ASImport': 'fas fa-file-import',
                'ASExport': 'fas fa-file-export',
                'ASComplete': 'fas fa-check-circle',
                'System': 'fas fa-info-circle'
            };

            try {
                const activity = await apiCall('/api/activities', {
                    method: 'POST',
                    body: JSON.stringify({
                        type,
                        message,
                        itemName,
                        icon: icons[type] || 'fas fa-bell'
                    })
                });

                appData.recentActivities.unshift(activity);
                if (appData.recentActivities.length > 50) {
                    appData.recentActivities.pop();
                }
            } catch (error) {
                console.error('활동 기록 실패:', error);
            }
        }

        // --- Utility Functions ---
        function getTodayString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function formatDate(date) {
            if (!date && date !== 0) return '';
            const d = new Date(date);
            if (isNaN(d.getTime())) {
                const excelEpoch = new Date(1899, 11, 30);
                d.setTime(excelEpoch.getTime() + (Number(date) - 1) * 86400000);
            }
            if (isNaN(d.getTime())) return '';
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function psmEscapeHtml(unsafe) {
            if (unsafe == null) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;");
        }

        // --- UI Functions ---
        async function showAsSubTab(tab) {
            asState.activeTab = tab;
            asState.activeCategory = (tab === 'dashboard' || tab === 'integrated') ? null : tab;

            document.querySelectorAll('#as-sub-nav .as-sub-nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`#as-sub-nav .as-sub-nav-btn[data-tab="${tab}"]`).classList.add('active');

            document.querySelectorAll('.as-sub-tab-content').forEach(content => content.classList.remove('active'));
            const contentEl = document.getElementById(`as-${tab}-content`);
            contentEl.classList.add('active');

            switch(tab) {
                case 'dashboard':
                    await renderAsDashboard();
                    break;
                case 'general':
                case 'converter':
                case 'floodlight':
                    await renderAsCategory(tab);
                    break;
                case 'integrated':
                    await renderAsIntegrated();
                    break;
            }
        }

        async function renderAsDashboard() {
            const container = document.getElementById('as-dashboard-content');
            if(!container) return;

            const allItems = [...appData.as.general, ...appData.as.converter, ...appData.as.floodlight];
            const total = allItems.length;
            const completed = allItems.filter(item => item.status === 'completed').length;
            const incomplete = total - completed;
            const completionRate = total > 0 ? ((completed / total) * 100).toFixed(1) : '0.0';

            const categoryStats = Object.keys(AS_CONFIG).map(cat => {
                const items = appData.as[cat];
                const catTotal = items.length;
                const catCompleted = items.filter(i => i.status === 'completed').length;
                const catIncomplete = catTotal - catCompleted;
                const catRate = catTotal > 0 ? ((catCompleted / catTotal) * 100).toFixed(1) : '0.0';
                return { name: AS_CONFIG[cat].name, total: catTotal, completed: catCompleted, incomplete: catIncomplete, rate: catRate };
            });

            // 최근 활동 HTML 생성
            const recentActivitiesHtml = appData.recentActivities.slice(0, 10).map(activity => {
                return `
                    <div class="flex items-center p-3 hover:bg-gray-700 hover:bg-opacity-30 rounded">
                        <i class="${activity.icon} text-blue-400 mr-3"></i>
                        <div class="flex-1">
                            <p class="text-sm text-white">${activity.message}</p>
                            <p class="text-xs text-gray-400">${new Date(activity.timestamp).toLocaleString('ko-KR')}</p>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div class="glass-card p-5"><p class="text-gray-400">총 A/S 건수</p><p class="text-white text-3xl font-bold">${total}</p></div>
                    <div class="glass-card p-5"><p class="text-gray-400">완료 건수</p><p class="text-green-400 text-3xl font-bold">${completed}</p></div>
                    <div class="glass-card p-5"><p class="text-gray-400">미완료 건수</p><p class="text-red-400 text-3xl font-bold">${incomplete}</p></div>
                    <div class="glass-card p-5"><p class="text-gray-400">전체 완료율</p><p class="text-blue-400 text-3xl font-bold">${completionRate}%</p></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="grid grid-cols-1 gap-6">
                        ${categoryStats.map(stat => `
                            <div class="glass-card p-5">
                                <h3 class="text-lg font-semibold text-white mb-3">${stat.name} 현황</h3>
                                <div class="flex justify-between items-center text-sm"><span>총계:</span> <span class="font-bold">${stat.total}</span></div>
                                <div class="flex justify-between items-center text-sm text-green-400"><span>완료:</span> <span class="font-bold">${stat.completed}</span></div>
                                <div class="flex justify-between items-center text-sm text-red-400"><span>미완료:</span> <span class="font-bold">${stat.incomplete}</span></div>
                                <div class="flex justify-between items-center text-sm text-blue-400 mt-2"><span>완료율:</span> <span class="font-bold">${stat.rate}%</span></div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="glass-card p-6">
                        <h3 class="text-lg font-semibold text-white mb-4">최근 활동</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${recentActivitiesHtml || '<div class="text-center text-gray-400 py-8">최근 활동이 없습니다.</div>'}
                        </div>
                    </div>
                </div>
                <div class="glass-card p-6">
                    <h3 class="text-xl font-semibold text-white mb-4">제품군별 A/S 현황</h3>
                    <div class="h-96"><canvas id="as-dashboard-chart"></canvas></div>
                </div>
            `;

            const chartEl = document.getElementById('as-dashboard-chart');
            if (chartEl) {
                if (asCharts.dashboard) asCharts.dashboard.destroy();
                asCharts.dashboard = new Chart(chartEl, {
                    type: 'bar',
                    data: {
                        labels: categoryStats.map(s => s.name),
                        datasets: [
                            {
                                label: '완료',
                                data: categoryStats.map(s => s.completed),
                                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                                borderColor: '#10b981',
                                borderWidth: 1
                            },
                            {
                                label: '미완료',
                                data: categoryStats.map(s => s.incomplete),
                                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                                borderColor: '#ef4444',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#e5e7eb' }, grid: { color: '#374151' } },
                            x: { ticks: { color: '#e5e7eb' }, grid: { color: '#374151' } }
                        },
                        plugins: {
                            legend: { position: 'bottom', labels: { color: '#e5e7eb' } },
                            datalabels: {
                                color: 'white',
                                anchor: 'end',
                                align: 'end',
                                formatter: (value) => value > 0 ? value : ''
                            }
                        }
                    }
                });
            }
        }

        async function renderAsCategory(category) {
            const container = document.getElementById(`as-${category}-content`);
            if(!container) return;

            const config = AS_CONFIG[category];
            const activeSubTab = asState.activeSubTab[category];

            container.innerHTML = `
                <div class="glass-card p-4 mb-6">
                    <div id="as-drop-zone-${category}" class="drag-drop-zone rounded-md" ondragover="handleDragOver(event, '${category}')" ondragleave="handleDragLeave(event, '${category}')" ondrop="handleDrop(event, '${category}')">
                        <p class="text-white">${config.name} Excel 파일을 여기로 드래그하거나 클릭하여 업로드</p>
                        <input type="file" id="as-file-input-${category}" accept=".xlsx, .xls, .csv" class="hidden" onchange="asHandleFileSelect(event, '${category}')">
                        <button class="mt-3 btn-green py-1 px-3 rounded text-sm" onclick="document.getElementById('as-file-input-${category}').click()">파일 선택</button>
                    </div>
                </div>
                <div class="border-b border-gray-700 mb-4">
                    <nav class="-mb-px flex space-x-6" aria-label="Tabs">
                        <button onclick="asSetCategorySubTab('${category}', 'incomplete')" class="as-sub-nav-btn ${activeSubTab === 'incomplete' ? 'active' : ''}">미완료</button>
                        <button onclick="asSetCategorySubTab('${category}', 'completed')" class="as-sub-nav-btn ${activeSubTab === 'completed' ? 'active' : ''}">완료</button>
                        <button onclick="asSetCategorySubTab('${category}', 'analysis')" class="as-sub-nav-btn ${activeSubTab === 'analysis' ? 'active' : ''}">분석(차트)</button>
                        <button onclick="asSetCategorySubTab('${category}', 'incomplete-list')" class="as-sub-nav-btn ${activeSubTab === 'incomplete-list' ? 'active' : ''}">미완료 제품 리스트</button>
                    </nav>
                </div>
                <div id="as-category-subcontent-${category}"></div>
            `;
            renderAsCategorySubContent(category);
        }

        function asSetCategorySubTab(category, subTab) {
            asState.activeSubTab[category] = subTab;
            renderAsCategory(category);
        }

        function renderAsCategorySubContent(category) {
            const container = document.getElementById(`as-category-subcontent-${category}`);
            const activeSubTab = asState.activeSubTab[category];

            if (activeSubTab === 'analysis') {
                container.innerHTML = `<div class="glass-card p-6 h-96"><canvas id="as-chart-${category}"></canvas></div>`;
                renderAsCategoryChart(category);
            } else if (activeSubTab === 'incomplete-list') {
                container.innerHTML = `
                    <div class="glass-card p-6">
                        <div id="as-incomplete-list-${category}"></div>
                    </div>
                `;
                renderAsCategoryIncompleteList(category);
            } else {
                const selectedCount = asState.selectedIds[category].size;
                container.innerHTML = `
                    <div class="glass-card p-4">
                        <div class="flex justify-between items-center mb-4 flex-wrap gap-4">
                            <div class="flex items-center gap-2">
                                <button class="btn-primary py-2 px-4 rounded-md text-sm" onclick="asOpenAddModal('${category}')"><i class="fas fa-plus mr-2"></i>항목 추가</button>
                                <button class="btn-red py-2 px-4 rounded-md text-sm" onclick="asDeleteSelected('${category}')" ${selectedCount === 0 ? 'disabled' : ''}><i class="fas fa-trash mr-2"></i>선택 삭제 (${selectedCount})</button>
                                <button class="btn-red py-2 px-4 rounded-md text-sm" onclick="asClearCategoryData('${category}')"><i class="fas fa-eraser mr-2"></i>데이터 초기화</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="text" id="as-search-${category}" class="p-2 rounded modal-input" placeholder="검색..." onkeyup="asSearchCategory('${category}')">
                                <button class="btn-orange py-2 px-4 rounded-md" onclick="asClearSearch('${category}')">초기화</button>
                                <span id="as-search-total-quantity-${category}" class="text-sm text-yellow-300 font-semibold ml-2"></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="btn-green py-2 px-4 rounded-md text-sm" onclick="asExport('${category}', true)">검색 결과 내보내기</button>
                                <button class="btn-green py-2 px-4 rounded-md text-sm" onclick="asExport('${category}', false)">현재탭 내보내기</button>
                                <button class="btn-orange py-2 px-4 rounded-md text-sm" onclick="asExportAllForCategory('${category}')">총 결과 내보내기</button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table id="as-table-${category}" class="min-w-full text-sm text-white"></table>
                        </div>
                    </div>
                `;
                renderAsCategoryTable(category);
            }
        }

        function renderAsCategoryTable(category) {
            const tbl = document.getElementById(`as-table-${category}`);
            if (!tbl) return;
            const cfg = AS_CONFIG[category];
            const active = asState.activeSubTab[category];

            const searchQuery = document.getElementById(`as-search-${category}`)?.value.toLowerCase() || '';

            const rows = appData.as[category]
                .filter(item => {
                    const statusMatch = (active === 'completed' ? item.status === 'completed' : item.status !== 'completed');
                    if (!statusMatch) return false;
                    if (searchQuery) {
                        return Object.values(item).some(value => String(value).toLowerCase().includes(searchQuery));
                    }
                    return true;
                })
                .sort((a, b) => (+a['NO.'] || 0) - (+b['NO.'] || 0));

            const totalQuantity = rows.reduce((sum, item) => sum + (parseInt(item['수량']) || 0), 0);
            const quantityDisplay = document.getElementById(`as-search-total-quantity-${category}`);
            if (quantityDisplay) {
                if (searchQuery) {
                    quantityDisplay.textContent = `검색된 총 수량: ${totalQuantity.toLocaleString()}`;
                } else {
                    quantityDisplay.textContent = '';
                }
            }

            const allVisibleChecked = rows.length > 0 && rows.every(item => asState.selectedIds[category].has(item.id));

            const headCols = [
                `<input type="checkbox" onchange="asToggleSelectAll(event, '${category}')" ${allVisibleChecked ? 'checked' : ''}>`,
                '편집',
                '삭제',
                ...Object.keys(cfg.fields)
            ];

            const headerHtml = `<thead><tr>${headCols.map(h => `<th class="p-2 text-left">${h}</th>`).join('')}</tr></thead>`;

            const bodyHtml = rows.map(r => {
                const isSelected = asState.selectedIds[category].has(r.id);
                let completionCell = r['완료일'] || '';
                if (r.status !== 'completed') {
                    completionCell = `<button class="btn-green py-1 px-2 rounded text-xs" onclick="asOpenCompleteModal('${category}', ${r.id})">완료 처리</button>`;
                }

                const cellsHtml = Object.entries(cfg.fields).map(([label, key]) => {
                    let value = r[key] || '';
                    let cellContent;

                    if (key === '완료일') {
                        cellContent = completionCell;
                    } else if (label === '호선번호' && value) {
                        const escapedHullNumber = psmEscapeHtml(value);
                        cellContent = `<a href="#" onclick="event.preventDefault(); showHullStatusModal('${escapedHullNumber}')" class="text-blue-300 hover:underline">${escapedHullNumber}</a>`;
                    } else {
                        cellContent = psmEscapeHtml(value);
                    }
                    return `<td class="p-2 whitespace-nowrap">${cellContent}</td>`;
                }).join('');

                return `
                <tr class="hover:bg-gray-700 ${isSelected ? 'bg-blue-900/50' : ''}">
                    <td class="p-2"><input type="checkbox" onchange="asToggleSelectOne(event,'${category}',${r.id})" ${isSelected ? 'checked' : ''}></td>
                    <td class="p-2 text-center">
                        <button onclick="asOpenAddModal('${category}',${r.id})" class="text-blue-400 hover:text-blue-300"><i class="fas fa-edit"></i></button>
                    </td>
                    <td class="p-2 text-center">
                        <button onclick="asDeleteSelectedRow('${category}',${r.id})" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
                    </td>
                    ${cellsHtml}
                </tr>`;
            }).join('');

            tbl.innerHTML = headerHtml + `<tbody>${bodyHtml}</tbody>`;
        }

        function asDeleteSelectedRow(category, id) {
            asState.selectedIds[category] = new Set([id]);
            asDeleteSelected(category);
        }

        function renderAsCategoryChart(category) {
            const chartEl = document.getElementById(`as-chart-${category}`);
            if(!chartEl) return;

            const data = appData.as[category];
            let top10Data;
            let chartLabel;

            if (category === 'converter') {
                chartLabel = '컨버터 코드';
                const counts = data.reduce((acc, item) => {
                    if (item['컨버터코드']) acc[item['컨버터코드']] = (acc[item['컨버터코드']] || 0) + (parseInt(item['수량']) || 0);
                    return acc;
                }, {});
                top10Data = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 10);
            } else {
                chartLabel = '대체 자재 코드';
                const counts = data.reduce((acc, item) => {
                    if (item['대체자재코드']) acc[item['대체자재코드']] = (acc[item['대체자재코드']] || 0) + (parseInt(item['수량']) || 0);
                    return acc;
                }, {});
                top10Data = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 10);
            }

            if (asCharts[category]) asCharts[category].destroy();
            asCharts[category] = new Chart(chartEl, {
                type: 'bar',
                data: {
                    labels: top10Data.map(d => d[0]),
                    datasets: [{
                        label: `Top 10 ${chartLabel} 수량`,
                        data: top10Data.map(d => d[1]),
                        backgroundColor: 'rgba(59, 130, 246, 0.7)',
                        borderColor: '#3b82f6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        y: { ticks: { color: '#e5e7eb' }, grid: { color: '#374151' } },
                        x: { ticks: { color: '#e5e7eb' }, grid: { color: '#374151' }, beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: `Top 10 ${chartLabel} 수량`, color: 'white', font: { size: 16 } },
                        datalabels: { color: 'white', anchor: 'end', align: 'end', formatter: (value) => value > 0 ? value : '' }
                    }
                }
            });
        }

        // 나머지 함수들은 원본과 동일하게 구현...
        // (계속해서 모든 함수를 완전히 구현)
